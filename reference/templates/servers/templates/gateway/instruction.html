<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gateway Server</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #1a1a2e; color: #eee; line-height: 1.6; }
        h1 { color: #4ec9b0; }
        h2 { color: #9cdcfe; margin-top: 2rem; }
        a { color: #4ec9b0; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .nav { background: #252536; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; }
        .nav a { margin-right: 1.5rem; }
        .card { background: #252536; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .card h3 { margin-top: 0; color: #dcdcaa; }
        .card p { margin-bottom: 0.5rem; color: #aaa; }
        .gateway-list { list-style: none; padding: 0; }
        .gateway-list li { padding: 0.75rem; border-bottom: 1px solid #333; }
        .gateway-list li:last-child { border-bottom: none; }
        .gateway-name { font-weight: bold; color: #9cdcfe; }
        .gateway-desc { color: #858585; font-size: 0.9rem; }
        code { font-family: 'Courier New', monospace; background: #1e1e2e; padding: 0.2rem 0.4rem; border-radius: 3px; }
        .tools { display: flex; gap: 1rem; flex-wrap: wrap; }
        .tool-card { flex: 1; min-width: 250px; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/servers/gateway">Server Definition</a>
        <a href="/variables/gateways">Gateway Configurations</a>
        <a href="/gateway/request">Request Tool</a>
        <a href="/gateway/response">Response Tool</a>
    </div>

    <h1>Gateway Server</h1>

    <p>The gateway server provides a unified interface for accessing internal servers with customizable request and response transformations.</p>

    <h2>How it Works</h2>

    <div class="card">
        <h3>URL Format</h3>
        <p><code>/gateway?target_server=&lt;url&gt;</code></p>
        <p>Use <code>target_server</code> to select the upstream REST API.</p>
        <p><code>request_transform</code> and <code>response_transform</code> optionally customize the request and response.</p>
        <p><code>/gateway/{server}/{path}</code></p>
        <p>Where <code>{server}</code> is a configured gateway name and <code>{path}</code> is passed to the internal server.</p>
    </div>

    <div class="card">
        <h3>Transformations</h3>
        <p>Each gateway defines:</p>
        <ul>
            <li><strong>Request Transform</strong> - Modifies the incoming request before sending to the target</li>
            <li><strong>Response Transform</strong> - Formats the response before returning to the user</li>
        </ul>
    </div>

    <h2>Development Tools</h2>

    <div class="tools">
        <div class="card tool-card">
            <h3><a href="/gateway/request">Request Experimenter</a></h3>
            <p>Test and modify request transformations interactively. Load previous invocations by CID.</p>
        </div>
        <div class="card tool-card">
            <h3><a href="/gateway/response">Response Experimenter</a></h3>
            <p>Test and modify response transformations interactively. Load previous invocations by CID.</p>
        </div>
    </div>

    <h2>Configured Gateways</h2>

    {% set mock_server_cid = "AAAAAAZCSIClksiwHZUoWgcSYgxDmR2pj2mgV1rz-oCey_hAB0soDmvPZ3ymH6P6NhOTDvgdbPTQHj8dqABcQw42a6wx5A" %}

    <div class="card">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">Name</th>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">Server</th>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">Gateway</th>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">Meta</th>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">Test</th>
                    <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #333;">External API</th>
                </tr>
            </thead>
            <tbody>
                {% macro external_api_link(server_name, external_api) -%}
                    {%- set url = None -%}
                    {%- set label = None -%}

                    {%- if server_name == "jsonplaceholder" -%}
                        {%- set url = "https://jsonplaceholder.typicode.com" -%}
                        {%- set label = "JSONPlaceholder API" -%}
                    {%- elif server_name == "json_api" -%}
                        {%- set url = "/servers/" ~ server_name -%}
                        {%- set label = "Configurable JSON API" -%}
                    {%- elif server_name in ["man", "tldr"] -%}
                        {%- set url = "/servers/" ~ server_name -%}
                        {%- set label = "Local command" -%}
                    {%- elif server_name in ["hrx", "cids"] -%}
                        {%- set url = "/servers/" ~ server_name -%}
                        {%- set label = "Internal content" -%}
                    {%- elif external_api and (external_api.startswith("http://") or external_api.startswith("https://")) -%}
                        {%- set url = external_api -%}
                        {%- if server_name == "github" -%}
                            {%- set label = "GitHub API" -%}
                        {%- elif server_name == "stripe" -%}
                            {%- set label = "Stripe API" -%}
                        {%- elif server_name == "openai" -%}
                            {%- set label = "OpenAI API" -%}
                        {%- elif server_name == "gemini" -%}
                            {%- set label = "Gemini API" -%}
                        {%- elif server_name == "teams" -%}
                            {%- set label = "Microsoft Teams API" -%}
                        {%- else -%}
                            {%- set label = server_name|replace('_', ' ')|title ~ " API" -%}
                        {%- endif -%}
                    {%- else -%}
                        {%- set url = "/servers/" ~ server_name -%}
                        {%- set label = external_api or "External service" -%}
                    {%- endif -%}

                    <a href="{{ url }}">{{ label }}</a>
                {%- endmacro %}

                {% for name, config in gateways.items() %}
                <tr>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;">
                        <span class="gateway-name">{{ name }}</span>
                        {% if config.description %}
                        <div class="gateway-desc">{{ config.description }}</div>
                        {% endif %}
                    </td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/servers/{{ name }}">Server</a></td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/{{ name }}">Gateway</a></td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/meta/{{ name }}">Meta</a></td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/test/cids/{{ mock_server_cid }}/as/{{ name }}">Test</a></td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #333;">
                        {{ external_api_link(name, config.external_api) }}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" style="padding: 0.75rem;">
                        <em>No gateways configured. Add gateway configurations to the <a href="/variables/gateways">gateways variable</a>.</em>
                    </td>
                </tr>
                {% endfor %}

                {% for server in external_servers or [] %}
                    {% if server.name and server.name not in gateways %}
                    <tr>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;">
                            <span class="gateway-name">{{ server.name }}</span>
                            <div class="gateway-desc">External service</div>
                        </td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/servers/{{ server.name }}">Server</a></td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/{{ server.name }}">Gateway</a></td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/meta/{{ server.name }}">Meta</a></td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;"><a href="/gateway/test/cids/{{ mock_server_cid }}/as/{{ server.name }}">Test</a></td>
                        <td style="padding: 0.5rem; border-bottom: 1px solid #333;">{{ external_api_link(server.name, server.external_api) }}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>
