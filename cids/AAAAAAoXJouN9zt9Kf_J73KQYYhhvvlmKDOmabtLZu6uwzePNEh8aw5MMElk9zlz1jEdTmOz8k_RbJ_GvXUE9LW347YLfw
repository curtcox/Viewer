# ruff: noqa: F821, F706
# pylint: disable=undefined-variable
"""HRX server for parsing and serving Human Readable Archive files.

HRX format specification: https://github.com/google/hrx
"""

from html import escape


def main(archive=None, path=None, *, context=None):
    """Parse and serve HRX archive files.

    Args:
        archive: HRX archive string (required)
        path: File path within the archive (optional)
        context: Server execution context (optional)

    Returns:
        Dictionary with 'output' and 'content_type' keys

    Raises:
        ValueError: If archive is not provided or path is not found
    """
    # Import the HRX parser
    from hrx_parser import HRXArchive, HRXParseError

    from cid_storage import resolve_cid_text

    # Resolve CID-or-text input.
    resolved_text = resolve_cid_text(archive)
    if resolved_text is not None:
        archive = resolved_text

    # Validate that archive is provided
    if archive is None or (isinstance(archive, str) and not archive.strip()):
        raise ValueError(
            "HRX archive is required. Usage: hrx(archive, path) where archive is the HRX string."
        )

    # Parse the archive
    try:
        hrx = HRXArchive(archive)
    except HRXParseError as e:
        raise ValueError(f"Invalid HRX archive: {e}") from e

    # If no path specified, return list of files
    if path is None or (isinstance(path, str) and not path.strip()):
        files = hrx.list_files()
        if not files:
            return {
                "output": "<html><body><h1>Empty Archive</h1><p>No files found in HRX archive.</p></body></html>",
                "content_type": "text/html",
            }

        # Build HTML list of files
        file_list_html = "<ul>"
        for file_path in files:
            safe_path = escape(file_path)
            file_list_html += f"<li><code>{safe_path}</code></li>"
        file_list_html += "</ul>"

        return {
            "output": f"""<html>
<head><title>HRX Archive Contents</title></head>
<body>
    <h1>HRX Archive Contents</h1>
    <p>Files in archive ({len(files)} total):</p>
    {file_list_html}
</body>
</html>""",
            "content_type": "text/html",
        }

    # Path specified - try to retrieve the file
    if not hrx.has_file(path):
        raise ValueError(
            f"File not found: {path}. Available files: {', '.join(hrx.list_files())}"
        )

    content = hrx.get_file(path)

    # Return the file content as plain text
    return {
        "output": content,
        "content_type": "text/plain",
    }
