# ruff: noqa: F821, F706
"""Interact with Webflow CMS and sites."""

from __future__ import annotations

from typing import Any, Dict, Optional

import requests

from server_utils.external_api import ExternalApiClient, error_output, validation_error


_DEFAULT_CLIENT = ExternalApiClient()


def _build_preview(
    *,
    operation: str,
    site_id: Optional[str],
    collection_id: Optional[str],
    item_id: Optional[str],
    payload: Optional[Dict[str, Any]],
) -> Dict[str, Any]:
    base_url = "https://api.webflow.com"

    if operation == "list_sites":
        url = f"{base_url}/sites"
        method = "GET"
    elif operation == "get_site":
        url = f"{base_url}/sites/{site_id}"
        method = "GET"
    elif operation == "publish_site":
        url = f"{base_url}/sites/{site_id}/publish"
        method = "POST"
    elif operation == "list_collections":
        url = f"{base_url}/sites/{site_id}/collections"
        method = "GET"
    elif operation == "get_collection":
        url = f"{base_url}/collections/{collection_id}"
        method = "GET"
    elif operation == "list_items":
        url = f"{base_url}/collections/{collection_id}/items"
        method = "GET"
    elif operation == "get_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "GET"
    elif operation == "create_item":
        url = f"{base_url}/collections/{collection_id}/items"
        method = "POST"
    elif operation == "update_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "PUT"
    elif operation == "delete_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "DELETE"
    else:
        url = base_url
        method = "GET"

    preview: Dict[str, Any] = {
        "operation": operation,
        "url": url,
        "method": method,
        "auth": "Bearer token",
    }
    if payload:
        preview["payload"] = payload
    return preview


def main(
    *,
    operation: str = "list_sites",
    site_id: str = "",
    collection_id: str = "",
    item_id: str = "",
    fields: Optional[Dict[str, Any]] = None,
    live: bool = False,
    WEBFLOW_API_TOKEN: str = "",
    dry_run: bool = True,
    timeout: int = 60,
    client: Optional[ExternalApiClient] = None,
    context=None,
) -> Dict[str, Any]:
    """List sites, collections, and manage CMS items in Webflow.

    Operations:
    - list_sites: List all sites
    - get_site: Get site details (requires site_id)
    - publish_site: Publish a site (requires site_id, supports live parameter)
    - list_collections: List all collections for a site (requires site_id)
    - get_collection: Get collection details (requires collection_id)
    - list_items: List all items in a collection (requires collection_id)
    - get_item: Get item details (requires collection_id and item_id)
    - create_item: Create a new item (requires collection_id and fields)
    - update_item: Update an item (requires collection_id, item_id, and fields)
    - delete_item: Delete an item (requires collection_id and item_id)

    Args:
        operation: The operation to perform
        site_id: The site ID (for site and collection operations)
        collection_id: The collection ID (for item operations)
        item_id: The item ID (for get/update/delete item operations)
        fields: Dictionary of field values for create/update operations
        live: Whether to publish to live domain (default: False publishes to staging)
        WEBFLOW_API_TOKEN: Webflow API token from account settings
        dry_run: If True, return preview without making actual API call
        timeout: Request timeout in seconds
        client: Optional ExternalApiClient for testing
        context: Request context
    """

    normalized_operation = operation.lower()
    valid_operations = {
        "list_sites", "get_site", "publish_site",
        "list_collections", "get_collection",
        "list_items", "get_item", "create_item", "update_item", "delete_item"
    }

    if normalized_operation not in valid_operations:
        return validation_error(
            f"Unsupported operation: {operation}. Must be one of {', '.join(sorted(valid_operations))}",
            field="operation"
        )

    # Validate required parameters based on operation
    if normalized_operation in {"get_site", "publish_site", "list_collections"} and not site_id:
        return validation_error(f"Missing required site_id for {normalized_operation}", field="site_id")

    if normalized_operation in {"get_collection", "list_items", "create_item"} and not collection_id:
        return validation_error(f"Missing required collection_id for {normalized_operation}", field="collection_id")

    if normalized_operation in {"get_item", "update_item", "delete_item"} and not collection_id:
        return validation_error(f"Missing required collection_id for {normalized_operation}", field="collection_id")

    if normalized_operation in {"get_item", "update_item", "delete_item"} and not item_id:
        return validation_error(f"Missing required item_id for {normalized_operation}", field="item_id")

    if normalized_operation in {"create_item", "update_item"} and not fields:
        return validation_error(f"Missing required fields for {normalized_operation}", field="fields")

    if not WEBFLOW_API_TOKEN:
        return error_output(
            "Missing WEBFLOW_API_TOKEN. Get your API token from Webflow Account Settings > Integrations",
            status_code=401
        )

    # Build payload for create/update operations
    payload = None
    if normalized_operation in {"create_item", "update_item"}:
        payload = {"fields": fields}
        if normalized_operation == "update_item":
            payload["_archived"] = False
            payload["_draft"] = False
    elif normalized_operation == "publish_site":
        payload = {"domains": ["live"] if live else []}

    # Dry-run preview
    if dry_run:
        preview = _build_preview(
            operation=normalized_operation,
            site_id=site_id,
            collection_id=collection_id,
            item_id=item_id,
            payload=payload,
        )
        return {"output": {"dry_run": True, "preview": preview}, "content_type": "application/json"}

    # Make the actual API call
    api_client = client or _DEFAULT_CLIENT
    base_url = "https://api.webflow.com"
    headers = {
        "Authorization": f"Bearer {WEBFLOW_API_TOKEN}",
        "accept-version": "1.0.0",
        "Content-Type": "application/json",
    }

    # Build URL based on operation
    if normalized_operation == "list_sites":
        url = f"{base_url}/sites"
        method = "GET"
    elif normalized_operation == "get_site":
        url = f"{base_url}/sites/{site_id}"
        method = "GET"
    elif normalized_operation == "publish_site":
        url = f"{base_url}/sites/{site_id}/publish"
        method = "POST"
    elif normalized_operation == "list_collections":
        url = f"{base_url}/sites/{site_id}/collections"
        method = "GET"
    elif normalized_operation == "get_collection":
        url = f"{base_url}/collections/{collection_id}"
        method = "GET"
    elif normalized_operation == "list_items":
        url = f"{base_url}/collections/{collection_id}/items"
        method = "GET"
    elif normalized_operation == "get_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "GET"
    elif normalized_operation == "create_item":
        url = f"{base_url}/collections/{collection_id}/items"
        method = "POST"
    elif normalized_operation == "update_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "PUT"
    elif normalized_operation == "delete_item":
        url = f"{base_url}/collections/{collection_id}/items/{item_id}"
        method = "DELETE"
    else:
        return validation_error(f"Unknown operation: {operation}")

    try:
        response = api_client.request(
            method=method,
            url=url,
            headers=headers,
            json=payload if payload else None,
            timeout=timeout,
        )

        if response.status_code == 401:
            return error_output(
                "Invalid or expired WEBFLOW_API_TOKEN. Check your API token in Webflow Account Settings",
                status_code=401
            )
        elif response.status_code == 403:
            return error_output(
                "Insufficient permissions for this operation. Check your API token has the required scopes",
                status_code=403
            )
        elif response.status_code == 404:
            return error_output(
                f"Resource not found (site_id={site_id}, collection_id={collection_id}, item_id={item_id})",
                status_code=404
            )

        response.raise_for_status()

        # Some operations return no content
        if response.status_code == 204 or not response.content:
            return {"output": {"success": True}, "content_type": "application/json"}

        try:
            data = response.json()
            return {"output": data, "content_type": "application/json"}
        except requests.exceptions.JSONDecodeError:
            return error_output(
                "Failed to parse API response as JSON",
                status_code=response.status_code,
                response=response.text[:500]
            )

    except requests.exceptions.Timeout:
        return error_output(
            f"Request timed out after {timeout} seconds. Try increasing the timeout parameter",
            status_code=408
        )
    except requests.exceptions.RequestException as e:
        status_code = e.response.status_code if e.response else None
        error_detail = e.response.text[:500] if e.response else str(e)
        return error_output(
            f"Webflow API request failed: {str(e)}",
            status_code=status_code,
            response=error_detail
        )
