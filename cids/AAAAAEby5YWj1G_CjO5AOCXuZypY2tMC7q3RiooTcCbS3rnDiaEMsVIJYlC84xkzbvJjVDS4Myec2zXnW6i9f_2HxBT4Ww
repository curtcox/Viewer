# ruff: noqa: F821, F706
# pylint: disable=undefined-variable,return-outside-function
"""Gateway server for proxying requests to external REST APIs.

This server acts as a proxy between the user and external API servers,
with optional request and response transformations.
"""

import json
from html import escape
from urllib.parse import urlparse, urljoin

import requests
from flask import request as flask_request


def main(target_server=None, request_transform=None, response_transform=None, context=None):
    """Gateway server main function.
    
    Parameters:
        target_server: Base URL of the target API server (e.g., 'https://api.github.com')
        request_transform: Optional server name to transform the request before sending
        response_transform: Optional server name to transform the response before returning
        context: Request context (automatically provided by the server execution framework)
    
    When target_server is not provided, displays an examples/instructions page.
    When target_server is provided, proxies requests to that server.
    """
    
    # If no target server is specified, show the examples page
    if not target_server:
        return _render_examples_page()
    
    # Get the path after the gateway mount point
    request_path = flask_request.path or "/"
    
    # Extract the path after /gateway (or whatever the mount point is)
    # The remaining path should be used as the request path to the target server
    path_parts = request_path.strip("/").split("/", 1)
    if len(path_parts) > 1:
        target_path = "/" + path_parts[1]
    else:
        target_path = "/"
    
    # Build the full target URL
    target_url = urljoin(target_server.rstrip("/") + "/", target_path.lstrip("/"))
    
    # Prepare request details for transformation
    request_details = {
        "url": target_url,
        "method": flask_request.method,
        "headers": dict(flask_request.headers),
        "query_string": flask_request.query_string.decode("utf-8"),
        "path": target_path,
        "original_path": request_path,
        "target_server": target_server,
    }
    
    # Apply request transformation if specified
    if request_transform:
        try:
            transform_result = _apply_transform(
                request_transform, 
                request_details,
                context
            )
            if isinstance(transform_result, dict) and "error" in transform_result:
                return transform_result
            request_details = transform_result
        except Exception as e:
            return {
                "output": _render_error_page(
                    "Request Transform Error",
                    f"Failed to transform request: {escape(str(e))}"
                ),
                "content_type": "text/html",
            }
    
    # Make the request to the target server
    try:
        response = _make_request(request_details)
    except Exception as e:
        return {
            "output": _render_error_page(
                "Request Failed",
                f"Failed to connect to target server: {escape(str(e))}"
            ),
            "content_type": "text/html",
        }
    
    # Prepare response details for transformation
    response_details = {
        "status_code": response.status_code,
        "headers": dict(response.headers),
        "content": response.content,
        "text": response.text if response.text else "",
        "request_details": request_details,
    }
    
    # Apply response transformation if specified
    if response_transform:
        try:
            transform_result = _apply_transform(
                response_transform,
                response_details,
                context
            )
            if isinstance(transform_result, dict) and "output" in transform_result:
                return transform_result
            response_details = transform_result
        except Exception as e:
            return {
                "output": _render_error_page(
                    "Response Transform Error",
                    f"Failed to transform response: {escape(str(e))}"
                ),
                "content_type": "text/html",
            }
    
    # Default: Convert JSON responses to HTML
    content_type = response.headers.get("Content-Type", "")
    if "application/json" in content_type:
        try:
            json_data = response.json()
            html_output = _render_json_as_html(
                json_data,
                target_server,
                request_path
            )
            return {
                "output": html_output,
                "content_type": "text/html",
            }
        except json.JSONDecodeError:
            pass
    
    # Return raw response
    return {
        "output": response.content,
        "content_type": content_type,
    }


def _render_examples_page():
    """Render the examples and instructions page."""
    
    examples = [
        {
            "name": "GitHub API",
            "description": "Browse the GitHub REST API",
            "link": "/gateway?target_server=https://api.github.com&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "OpenAI API",
            "description": "OpenAI API endpoints",
            "link": "/gateway?target_server=https://api.openai.com&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "Anthropic API",
            "description": "Anthropic Claude API",
            "link": "/gateway?target_server=https://api.anthropic.com&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "Google AI API",
            "description": "Google Gemini and AI APIs",
            "link": "/gateway?target_server=https://generativelanguage.googleapis.com&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "OpenRouter API",
            "description": "OpenRouter unified API",
            "link": "/gateway?target_server=https://openrouter.ai&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "Eleven Labs API",
            "description": "Text-to-speech and voice APIs",
            "link": "/gateway?target_server=https://api.elevenlabs.io&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "Vercel API",
            "description": "Vercel deployment and project API",
            "link": "/gateway?target_server=https://api.vercel.com&response_transform=gateway_json_to_html",
            "requires_auth": True,
        },
        {
            "name": "JSONPlaceholder",
            "description": "Free fake API for testing (no auth required)",
            "link": "/gateway?target_server=https://jsonplaceholder.typicode.com&response_transform=gateway_json_to_html",
            "requires_auth": False,
        },
    ]
    
    html_parts = [
        "<!DOCTYPE html>",
        "<html>",
        "<head>",
        "    <meta charset='utf-8'>",
        "    <title>Gateway Server - API Examples</title>",
        "    <style>",
        "        body { font-family: system-ui, -apple-system, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }",
        "        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 0.5rem; }",
        "        h2 { color: #34495e; margin-top: 2rem; }",
        "        .example { background: #f8f9fa; border-left: 4px solid #3498db; padding: 1rem; margin: 1rem 0; border-radius: 4px; }",
        "        .example h3 { margin-top: 0; color: #2980b9; }",
        "        .example p { margin: 0.5rem 0; color: #555; }",
        "        .auth-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: 600; margin-left: 0.5rem; }",
        "        .auth-required { background: #ffe5e5; color: #c0392b; }",
        "        .no-auth { background: #e5ffe5; color: #27ae60; }",
        "        .link { display: inline-block; margin-top: 0.5rem; padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; }",
        "        .link:hover { background: #2980b9; }",
        "        .instructions { background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 1rem 0; border-radius: 4px; }",
        "        code { background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: 'Courier New', monospace; }",
        "        pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }",
        "    </style>",
        "</head>",
        "<body>",
        "    <h1>üåê Gateway Server</h1>",
        "    <p>The Gateway Server acts as a proxy to external REST APIs, transforming responses into browsable HTML pages with embedded links.</p>",
        "    ",
        "    <div class='instructions'>",
        "        <h2>How it Works</h2>",
        "        <p>The gateway server:</p>",
        "        <ul>",
        "            <li>Routes requests to external API servers</li>",
        "            <li>Optionally transforms requests before sending</li>",
        "            <li>Optionally transforms responses before displaying</li>",
        "            <li>Converts JSON responses to browsable HTML with clickable links</li>",
        "        </ul>",
        "        <h3>Parameters</h3>",
        "        <ul>",
        "            <li><code>target_server</code> - Base URL of the API server (required)</li>",
        "            <li><code>request_transform</code> - Server name to transform requests (optional)</li>",
        "            <li><code>response_transform</code> - Server name to transform responses (optional)</li>",
        "        </ul>",
        "    </div>",
        "    ",
        "    <h2>API Examples</h2>",
    ]
    
    for example in examples:
        auth_class = "auth-required" if example["requires_auth"] else "no-auth"
        auth_text = "API Key Required" if example["requires_auth"] else "No Auth"
        
        html_parts.extend([
            "    <div class='example'>",
            f"        <h3>{escape(example['name'])}<span class='auth-badge {auth_class}'>{auth_text}</span></h3>",
            f"        <p>{escape(example['description'])}</p>",
            f"        <a href='{escape(example['link'])}' class='link'>Browse API</a>",
            "    </div>",
        ])
    
    html_parts.extend([
        "    ",
        "    <h2>Usage Example</h2>",
        "    <pre>",
        "/gateway?target_server=https://api.github.com&response_transform=gateway_json_to_html",
        "    </pre>",
        "    <p>This will browse the GitHub API root and convert responses to HTML with clickable links.</p>",
        "</body>",
        "</html>",
    ])
    
    return {
        "output": "\n".join(html_parts),
        "content_type": "text/html",
    }


def _render_error_page(title, message):
    """Render an error page."""
    return f"""<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>{escape(title)}</title>
    <style>
        body {{ font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }}
        .error {{ background: #fee; border-left: 4px solid #c33; padding: 1rem; border-radius: 4px; }}
        h1 {{ color: #c33; }}
    </style>
</head>
<body>
    <div class='error'>
        <h1>{escape(title)}</h1>
        <p>{message}</p>
    </div>
</body>
</html>"""


def _render_json_as_html(data, target_server, current_path):
    """Render JSON data as formatted HTML with embedded links."""
    
    html_parts = [
        "<!DOCTYPE html>",
        "<html>",
        "<head>",
        "    <meta charset='utf-8'>",
        "    <title>API Response</title>",
        "    <style>",
        "        body { font-family: 'Courier New', monospace; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; background: #1e1e1e; color: #d4d4d4; }",
        "        pre { background: #252526; padding: 1.5rem; border-radius: 8px; overflow-x: auto; line-height: 1.5; }",
        "        .json-key { color: #9cdcfe; }",
        "        .json-string { color: #ce9178; }",
        "        .json-number { color: #b5cea8; }",
        "        .json-boolean { color: #569cd6; }",
        "        .json-null { color: #569cd6; }",
        "        .json-url { color: #4ec9b0; text-decoration: underline; cursor: pointer; }",
        "        .json-url:hover { color: #4fc3f7; }",
        "        h1 { color: #4ec9b0; font-size: 1.5rem; }",
        "        .breadcrumb { color: #858585; margin-bottom: 1rem; }",
        "        a { color: #4ec9b0; text-decoration: none; }",
        "        a:hover { text-decoration: underline; }",
        "    </style>",
        "</head>",
        "<body>",
        f"    <div class='breadcrumb'>Gateway: {escape(target_server)} {escape(current_path)}</div>",
        "    <h1>API Response</h1>",
        "    <pre>",
    ]
    
    # Format JSON with syntax highlighting and links
    formatted_json = _format_json_with_links(data, target_server, current_path, indent=0)
    html_parts.append(formatted_json)
    
    html_parts.extend([
        "    </pre>",
        "</body>",
        "</html>",
    ])
    
    return "\n".join(html_parts)


def _format_json_with_links(obj, target_server, current_path, indent=0):
    """Format JSON with syntax highlighting and convert URLs to gateway links."""
    indent_str = "  " * indent
    
    if obj is None:
        return f"<span class='json-null'>null</span>"
    
    if isinstance(obj, bool):
        return f"<span class='json-boolean'>{str(obj).lower()}</span>"
    
    if isinstance(obj, (int, float)):
        return f"<span class='json-number'>{obj}</span>"
    
    if isinstance(obj, str):
        # Check if string looks like a URL for the target server
        if _is_api_url(obj, target_server):
            gateway_link = _convert_to_gateway_link(obj, target_server, current_path)
            return f"<a href='{escape(gateway_link)}' class='json-url'>\"<span class='json-string'>{escape(obj)}</span>\"</a>"
        return f"<span class='json-string'>\"{escape(obj)}\"</span>"
    
    if isinstance(obj, list):
        if not obj:
            return "[]"
        
        items = []
        for item in obj:
            formatted_item = _format_json_with_links(item, target_server, current_path, indent + 1)
            items.append(f"{indent_str}  {formatted_item}")
        
        return "[\n" + ",\n".join(items) + f"\n{indent_str}]"
    
    if isinstance(obj, dict):
        if not obj:
            return "{}"
        
        items = []
        for key, value in obj.items():
            formatted_value = _format_json_with_links(value, target_server, current_path, indent + 1)
            items.append(f"{indent_str}  <span class='json-key'>\"{escape(str(key))}\"</span>: {formatted_value}")
        
        return "{\n" + ",\n".join(items) + f"\n{indent_str}" + "}"
    
    return f"<span class='json-string'>\"{escape(str(obj))}\"</span>"


def _is_api_url(value, target_server):
    """Check if a string value represents a URL for the target API."""
    if not isinstance(value, str):
        return False
    
    # Parse the target server
    parsed_target = urlparse(target_server)
    target_domain = parsed_target.netloc
    
    # Check if value is a full URL matching the target server
    if value.startswith("http://") or value.startswith("https://"):
        parsed_value = urlparse(value)
        return parsed_value.netloc == target_domain
    
    # Check if value looks like an API path (starts with /)
    if value.startswith("/") and len(value) > 1:
        return True
    
    return False


def _convert_to_gateway_link(url, target_server, current_path):
    """Convert an API URL to a gateway link."""
    parsed_target = urlparse(target_server)
    
    # If it's a full URL, extract just the path
    if url.startswith("http://") or url.startswith("https://"):
        parsed_url = urlparse(url)
        api_path = parsed_url.path
        query = f"?{parsed_url.query}" if parsed_url.query else ""
    else:
        # It's already a path
        api_path = url
        query = ""
    
    # Build gateway link
    gateway_base = "/gateway"
    
    # Extract the gateway mount point from current_path if present
    if "/gateway" in current_path:
        gateway_mount = current_path.split("/gateway")[0] + "/gateway"
    else:
        gateway_mount = "/gateway"
    
    return f"{gateway_mount}{api_path}{query}?target_server={target_server}"


def _make_request(request_details):
    """Make an HTTP request to the target server."""
    url = request_details["url"]
    method = request_details.get("method", "GET")
    headers = request_details.get("headers", {})
    
    # Filter out problematic headers
    filtered_headers = {}
    for key, value in headers.items():
        lower_key = key.lower()
        if lower_key not in {"host", "content-length"}:
            filtered_headers[key] = value
    
    # Get request body if present
    body = flask_request.get_data(cache=False) or None
    
    response = requests.request(
        method,
        url,
        headers=filtered_headers,
        data=body,
        allow_redirects=False,
        timeout=30,
    )
    
    return response


def _apply_transform(transform_server_name, data, context_info):
    """Apply a transformation server to the data.
    
    This would execute the named server with the data as input.
    For now, this is a placeholder that would need to integrate with
    the server execution system.
    """
    # This is a placeholder - in a real implementation, this would:
    # 1. Look up the transform server by name
    # 2. Execute it with the data as input
    # 3. Return the transformed result
    
    # For now, just return the data unchanged
    return data
