<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gateway Meta: {{ server_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/custom.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 1rem; background: #1a1a2e; color: #eee; line-height: 1.6; }
        h1 { color: #4ec9b0; }
        h2 { color: #9cdcfe; margin-top: 2rem; }
        a { color: #4ec9b0; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .nav { background: #252536; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; }
        .nav a { margin-right: 1.5rem; }
        .card { background: #252536; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .card h3 { margin-top: 0; color: #dcdcaa; }
        code { font-family: 'Courier New', monospace; background: #1e1e2e; padding: 0.2rem 0.4rem; border-radius: 3px; }
        pre { background: #1e1e2e; padding: 1rem; border-radius: 4px; font-family: 'Courier New', monospace; overflow-x: auto; white-space: pre-wrap; }
        .status { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.9rem; margin-left: 0.5rem; }
        .status.valid { background: #1f3d1f; color: #4f4; }
        .status.error { background: #3d1f1f; color: #f44; }
        .status.warning { background: #3d3d1f; color: #ff4; }
        .error-detail { color: #f88; margin-top: 0.5rem; padding: 0.5rem; background: #2a1515; border-radius: 4px; }
        .warning-detail { color: #ff8; margin-top: 0.5rem; padding: 0.5rem; background: #2a2a15; border-radius: 4px; }
        .info-row { display: flex; gap: 1rem; margin-bottom: 0.5rem; }
        .info-label { color: #858585; min-width: 120px; }
        .info-value { color: #eee; }
        .test-links { margin-top: 1rem; }
        .test-links a { display: inline-block; margin-right: 1rem; padding: 0.5rem 1rem; background: #333; border-radius: 4px; }
        .test-links a:hover { background: #444; }

        /* Ensure source/code blocks remain readable on the dark theme. */
        pre { color: #eee; }
        code { color: #dcdcaa; }

        /* CID dropdown styling: the app-wide CID controls assume light pages; this page is dark. */
        .cid-display { color: #eee; }
        .cid-display .cid-link { color: #4ec9b0; }
        .cid-display .cid-link:hover,
        .cid-display .cid-link:focus { color: #9cdcfe; }

        .cid-display .cid-menu-btn.btn-outline-secondary {
            color: #eee;
            border-color: #666;
            background: transparent;
        }
        .cid-display .cid-menu-btn.btn-outline-secondary:hover,
        .cid-display .cid-menu-btn.btn-outline-secondary:focus {
            color: #1a1a2e;
            background: #9cdcfe;
            border-color: #9cdcfe;
        }

        .cid-display .dropdown-menu {
            background: #1e1e2e;
            border: 1px solid #333;
        }
        .cid-display .dropdown-menu .dropdown-item {
            color: #eee;
        }
        .cid-display .dropdown-menu .dropdown-item:hover,
        .cid-display .dropdown-menu .dropdown-item:focus {
            background: #252536;
            color: #fff;
        }
        .cid-display .dropdown-menu .dropdown-divider {
            border-top-color: #333;
        }
        .cid-display .dropdown-menu .dropdown-item i {
            color: #a0a0a0 !important;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/gateway">Gateway Home</a>
        <a href="/gateway/{{ server_name }}">Use Gateway</a>
        <a href="/gateway/request">Request Tool</a>
        <a href="/gateway/response">Response Tool</a>
    </div>

    <h1>Gateway Meta: {{ server_name }}</h1>

    <div class="card">
        <h3>Configuration</h3>
        <div class="info-row">
            <span class="info-label">Gateway Name:</span>
            <span class="info-value">{{ server_name }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Description:</span>
            <span class="info-value">{{ config.description }}</span>
        </div>
        {% if server_exists %}
        <div class="info-row">
            <span class="info-label">Server Definition:</span>
            <span class="info-value"><a href="/servers/{{ server_name }}">View Server</a></span>
        </div>
        {% if server_definition_info %}
        <div class="info-row">
            <span class="info-label">Server Definition Type:</span>
            <span class="info-value"><code>{{ server_definition_info.definition_type }}</code></span>
        </div>
        <div class="info-row">
            <span class="info-label">Server Definition Valid:</span>
            <span class="info-value">
                {% if server_definition_info.definition_is_str %}
                    <span class="status valid">Yes</span>
                {% else %}
                    <span class="status error">No</span>
                {% endif %}
            </span>
        </div>
        {% if not server_definition_info.definition_is_str %}
        <div class="error-detail">
            Server definition is not a string. Gateway execution may fail or behave unexpectedly.
            {% if server_definition_diagnostics_url %}
                <a href="{{ server_definition_diagnostics_url }}">View server definition diagnostics</a>
            {% endif %}
        </div>
        {% endif %}
        {% if server_definition_info.definition_preview %}
        <pre>{{ server_definition_info.definition_preview }}</pre>
        {% endif %}
        {% endif %}
        {% endif %}
    </div>

    <div class="card">
        <h3>
            Request Transform
            <span class="status {{ request_transform_status }}">{{ request_transform_status_text }}</span>
        </h3>
        <div class="info-row">
            <span class="info-label">CID:</span>
            <span class="info-value">
                {% if request_cid_lookup %}
                    {{ request_cid_link_html | safe }}
                {% else %}
                    <code>{{ config.request_transform_cid }}</code>
                {% endif %}
            </span>
        </div>
        {% if request_transform_error %}
        <div class="error-detail">{{ request_transform_error }}</div>
        {% endif %}
        {% if request_transform_warnings %}
        {% for warning in request_transform_warnings %}
        <div class="warning-detail">{{ warning }}</div>
        {% endfor %}
        {% endif %}
        {% if request_transform_source %}
        <pre>{{ request_transform_source | e }}</pre>
        {% else %}
        <p><em>Transform source not available</em></p>
        {% endif %}
    </div>

    <div class="card">
        <h3>
            Response Transform
            <span class="status {{ response_transform_status }}">{{ response_transform_status_text }}</span>
        </h3>
        <div class="info-row">
            <span class="info-label">CID:</span>
            <span class="info-value">
                {% if response_cid_lookup %}
                    {{ response_cid_link_html | safe }}
                {% else %}
                    <code>{{ config.response_transform_cid }}</code>
                {% endif %}
            </span>
        </div>
        {% if response_transform_error %}
        <div class="error-detail">{{ response_transform_error }}</div>
        {% endif %}
        {% if response_transform_warnings %}
        {% for warning in response_transform_warnings %}
        <div class="warning-detail">{{ warning }}</div>
        {% endfor %}
        {% endif %}
        {% if response_transform_source %}
        <pre>{{ response_transform_source | e }}</pre>
        {% else %}
        <p><em>Transform source not available</em></p>
        {% endif %}
    </div>

    {% if templates_info %}
    <div class="card">
        <h3>Templates</h3>
        {% for tpl in templates_info %}
        <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #333;">
            <h4 style="color: #9cdcfe; margin-top: 0;">
                {{ tpl.name }}
                <span class="status {{ tpl.status }}">{{ tpl.status_text }}</span>
            </h4>
            <div class="info-row">
                <span class="info-label">CID:</span>
                <span class="info-value">
                    {% if tpl.cid_link_html %}
                        {{ tpl.cid_link_html | safe }}
                    {% else %}
                        <code>{{ tpl.cid }}</code>
                    {% endif %}
                </span>
            </div>
            {% if tpl.variables %}
            <div class="info-row">
                <span class="info-label">Variables:</span>
                <span class="info-value">
                    <code>{{ tpl.variables | join(', ') }}</code>
                    <span style="color: #858585; font-size: 0.9rem;">(auto-detected, may be incomplete)</span>
                </span>
            </div>
            {% endif %}
            {% if tpl.error %}
            <div class="error-detail">{{ tpl.error }}</div>
            {% endif %}
            {% if tpl.source %}
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: #9cdcfe;">View Template Source</summary>
                <pre style="margin-top: 0.5rem;">{{ tpl.source | e }}</pre>
            </details>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% elif config.response_transform_cid or config.request_transform_cid %}
    <div class="card">
        <h3>Templates</h3>
        <p><em>No templates configured for this gateway.</em></p>
        <p style="color: #858585; font-size: 0.9rem;">Note: Transforms may use inline templates or external templates may need to be configured.</p>
    </div>
    {% endif %}

    <div class="card">
        <h3>Test Links</h3>
        <div class="test-links">
            <a href="/gateway/{{ server_name }}">Gateway Root</a>
            {% for path in test_paths %}
            <a href="/gateway/{{ server_name }}/{{ path }}">{{ path }}</a>
            {% endfor %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('click', function (event) {
        const trigger = event.target.closest('.cid-copy-action');
        if (!trigger) {
            return;
        }

        event.preventDefault();

        const copyPath = trigger.getAttribute('data-copy-path');
        if (!copyPath) {
            return;
        }

        const originalHtml = trigger.innerHTML;

        navigator.clipboard.writeText(`${window.location.origin}${copyPath}`).then(() => {
            trigger.innerHTML = '<i class="fas fa-check text-success me-2"></i>Copied!';
            trigger.classList.add('disabled');

            const dropdownToggle = trigger.closest('.dropdown')?.querySelector('[data-bs-toggle="dropdown"]');
            if (dropdownToggle && window.bootstrap && window.bootstrap.Dropdown) {
                const dropdownInstance = window.bootstrap.Dropdown.getInstance(dropdownToggle) || new window.bootstrap.Dropdown(dropdownToggle);
                dropdownInstance.hide();
            }

            setTimeout(() => {
                trigger.innerHTML = originalHtml;
                trigger.classList.remove('disabled');
            }, 2000);
        }).catch(() => {
            trigger.innerHTML = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>Copy failed';
            setTimeout(() => {
                trigger.innerHTML = originalHtml;
            }, 2000);
        });
    });
    </script>
    <script src="/static/js/cid_editor_controls.js"></script>
</body>
</html>
