{% macro ai_text_controls(target_id, target_label, request_label=None, helper_text=None, context=None, rows=3, entity_type=None, entity_name=None, entity_name_field=None, interactions=None, history_label='Recent activity', history_limit=10) %}
    {% set request_id = target_id ~ '-ai-input' %}
    {% set output_id = target_id ~ '-ai-output' %}
    {% set interactions = interactions or [] %}
    <div class="mb-3 ai-text-assistant"
         data-ai-target-id="{{ target_id }}"
         data-ai-target-label="{{ target_label }}"
         data-ai-history-limit="{{ history_limit }}"
         {% if entity_type %}data-ai-entity-type="{{ entity_type }}"{% endif %}
         {% if entity_name %}data-ai-entity-name="{{ entity_name }}"{% endif %}
         {% if entity_name_field %}data-ai-entity-name-field="{{ entity_name_field }}"{% endif %}
         {% if context is not none %}data-ai-context='{{ context | tojson }}'{% endif %}>
        <label for="{{ request_id }}" class="form-label">{{ request_label or ('Describe the change or AI request for the ' ~ target_label) }}</label>
        <textarea id="{{ request_id }}"
                  class="form-control"
                  rows="{{ rows }}"
                  data-ai-input
                  placeholder="Share instructions for AI or summarise manual edits to the {{ target_label }}."></textarea>
        <div class="form-text">{{ helper_text or ('Use this field to instruct the AI or to describe the changes you made manually before saving.') }}</div>
        <input type="hidden" name="change_message" data-change-message-store>
        <div class="alert alert-info d-none mt-3"
             id="{{ output_id }}"
             data-ai-output
             role="status"></div>
        <div class="mt-3">
            <label class="form-label small text-uppercase fw-semibold">{{ history_label }}</label>
            <div class="list-group list-group-flush border rounded" data-ai-history-list>
                {% for item in interactions %}
                <button type="button"
                        class="list-group-item list-group-item-action"
                        data-ai-interaction
                        data-interaction='{{ item | tojson }}'>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge bg-light text-dark border">{{ item.action_display }}</span>
                        {% if item.timestamp_url %}
                        <small class="text-muted">
                            <a href="{{ url_for('main.history', start=item.timestamp_url, end=item.timestamp_url_end) }}" 
                               class="text-decoration-none text-muted" 
                               title="View history at this time"
                               onclick="event.stopPropagation()">
                                {{ item.timestamp }}
                            </a>
                            <span class="mx-1">|</span>
                            <a href="{{ url_for('main.server_events', start=item.timestamp_url, end=item.timestamp_url_end) }}" 
                               class="text-decoration-none text-muted" 
                               title="View server events at this time"
                               onclick="event.stopPropagation()">
                                <i class="fas fa-server" style="font-size: 0.75em;"></i>
                            </a>
                        </small>
                        {% else %}
                        <small class="text-muted">{{ item.timestamp }}</small>
                        {% endif %}
                    </div>
                    <div class="text-truncate">{{ item.preview }}</div>
                </button>
                {% endfor %}
            </div>
            <div class="text-muted small mt-2 {% if interactions %}d-none{% endif %}" data-ai-history-empty>
                No interactions yet.
            </div>
        </div>
    </div>
{% endmacro %}

{% macro ai_action_button(target_id, button_label='AI', extra_classes='btn-outline-primary btn') %}
    {% set classes = extra_classes.split(' ') %}
    {% if 'btn' not in classes %}
        {% set classes = ['btn'] + classes %}
    {% endif %}
    {% set button_classes = classes | join(' ') %}
    <div class="btn-group" role="group">
        <button type="button"
                class="{{ button_classes }}"
                data-ai-trigger
                data-ai-target-id="{{ target_id }}">
            <i class="fas fa-robot me-1"></i>{{ button_label }}
        </button>
        <button type="button"
                class="{{ button_classes }} dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="AI options">
            <span class="visually-hidden">AI options</span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item"
                   href="#"
                   data-ai-request-editor
                   data-ai-target-id="{{ target_id }}">
                    AI request editor
                </a>
            </li>
            <li><a class="dropdown-item" href="/aliases/ai">AI action editor</a></li>
            <li><a class="dropdown-item" href="/servers/ai_stub">Sample AI server</a></li>
            <li><a class="dropdown-item" href="/ai_about">About AI</a></li>
        </ul>
    </div>
{% endmacro %}
