{% extends "base.html" %}

{% block title %}Export Data{% endblock %}

{% block content %}
{% macro render_export_preview(preview) %}
    {% if preview is not defined or not preview %}
        <div class="text-muted small fst-italic">No items available for export.</div>
    {% elif not preview.include %}
        <div class="text-muted small fst-italic">{{ preview.not_selected_message }}</div>
    {% elif preview.selected %}
        <ul class="list-unstyled small mb-0">
            {% for item in preview.selected %}
                <li>{{ item.name }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-muted small fst-italic">{{ preview.empty_message }}</div>
    {% endif %}
{% endmacro %}
<div class="container-fluid px-3 px-lg-5">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
        <h2 class="mb-0"><i class="fas fa-download me-2"></i>Export Data</h2>
        <a href="{{ url_for('main.settings') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Settings
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Select Data to Export</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}

                <p class="text-muted">Choose the collections you want to include in the exported JSON file.</p>

                <div class="alert alert-secondary d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-2" id="export-size-indicator">
                    <div>
                        <strong>Estimated export size:</strong>
                        <span id="export-size-value">—</span>
                    </div>
                    <div class="text-muted small" id="export-size-status"></div>
                </div>

                {% if form.include_aliases.errors %}
                <div class="alert alert-danger">
                    {% for error in form.include_aliases.errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="export-option mb-3 pb-3 border-bottom">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <div class="form-check m-0 flex-grow-1">
                            {{ form.include_aliases(class="form-check-input", id="include-aliases") }}
                            <label class="form-check-label" for="include-aliases">
                                <i class="fas fa-link me-1 text-info"></i>
                                <a class="text-reset text-decoration-none" href="{{ url_for('main.aliases') }}">{{ form.include_aliases.label.text }}</a>
                            </label>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-3 ms-auto{{ '' if form.include_aliases.data else ' d-none' }}" id="alias-options">
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_disabled_aliases(class="form-check-input", id="include-disabled-aliases", disabled=(not form.include_aliases.data)) }}
                                <label class="form-check-label" for="include-disabled-aliases">
                                    <i class="fas fa-ban me-1 text-danger"></i>{{ form.include_disabled_aliases.label.text }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_template_aliases(class="form-check-input", id="include-template-aliases", disabled=(not form.include_aliases.data)) }}
                                <label class="form-check-label" for="include-template-aliases">
                                    <i class="fas fa-copy me-1 text-secondary"></i>{{ form.include_template_aliases.label.text }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="w-100 mt-2" data-export-preview="aliases">
                        {{ render_export_preview(export_preview.aliases) }}
                    </div>
                </div>

                <div class="export-option mb-3 pb-3 border-bottom">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <div class="form-check m-0 flex-grow-1">
                            {{ form.include_servers(class="form-check-input", id="include-servers") }}
                            <label class="form-check-label" for="include-servers">
                                <i class="fas fa-server me-1 text-primary"></i>
                                <a class="text-reset text-decoration-none" href="{{ url_for('main.servers') }}">{{ form.include_servers.label.text }}</a>
                            </label>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-3 ms-auto{{ '' if form.include_servers.data else ' d-none' }}" id="server-options">
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_disabled_servers(class="form-check-input", id="include-disabled-servers", disabled=(not form.include_servers.data)) }}
                                <label class="form-check-label" for="include-disabled-servers">
                                    <i class="fas fa-ban me-1 text-danger"></i>{{ form.include_disabled_servers.label.text }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_template_servers(class="form-check-input", id="include-template-servers", disabled=(not form.include_servers.data)) }}
                                <label class="form-check-label" for="include-template-servers">
                                    <i class="fas fa-copy me-1 text-secondary"></i>{{ form.include_template_servers.label.text }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="w-100 mt-2" data-export-preview="servers">
                        {{ render_export_preview(export_preview.servers) }}
                    </div>
                </div>

                <div class="export-option mb-3 pb-3 border-bottom">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <div class="form-check m-0 flex-grow-1">
                            {{ form.include_variables(class="form-check-input", id="include-variables") }}
                            <label class="form-check-label" for="include-variables">
                                <i class="fas fa-code me-1 text-success"></i>
                                <a class="text-reset text-decoration-none" href="{{ url_for('main.variables') }}">{{ form.include_variables.label.text }}</a>
                            </label>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-3 ms-auto{{ '' if form.include_variables.data else ' d-none' }}" id="variable-options">
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_disabled_variables(class="form-check-input", id="include-disabled-variables", disabled=(not form.include_variables.data)) }}
                                <label class="form-check-label" for="include-disabled-variables">
                                    <i class="fas fa-ban me-1 text-danger"></i>{{ form.include_disabled_variables.label.text }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_template_variables(class="form-check-input", id="include-template-variables", disabled=(not form.include_variables.data)) }}
                                <label class="form-check-label" for="include-template-variables">
                                    <i class="fas fa-copy me-1 text-secondary"></i>{{ form.include_template_variables.label.text }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="w-100 mt-2" data-export-preview="variables">
                        {{ render_export_preview(export_preview.variables) }}
                    </div>
                </div>

                <div class="export-option mb-3 pb-3 border-bottom">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <div class="form-check m-0 flex-grow-1">
                            {{ form.include_secrets(class="form-check-input", id="include-secrets") }}
                            <label class="form-check-label" for="include-secrets">
                                <i class="fas fa-key me-1 text-warning"></i>
                                <a class="text-reset text-decoration-none" href="{{ url_for('main.secrets') }}">{{ form.include_secrets.label.text }}</a>
                            </label>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-3 ms-auto{{ '' if form.include_secrets.data else ' d-none' }}" id="secret-options">
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_disabled_secrets(class="form-check-input", id="include-disabled-secrets", disabled=(not form.include_secrets.data)) }}
                                <label class="form-check-label" for="include-disabled-secrets">
                                    <i class="fas fa-ban me-1 text-danger"></i>{{ form.include_disabled_secrets.label.text }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline m-0">
                                {{ form.include_template_secrets(class="form-check-input", id="include-template-secrets", disabled=(not form.include_secrets.data)) }}
                                <label class="form-check-label" for="include-template-secrets">
                                    <i class="fas fa-copy me-1 text-secondary"></i>{{ form.include_template_secrets.label.text }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="w-100 mt-2" data-export-preview="secrets">
                        {{ render_export_preview(export_preview.secrets) }}
                    </div>
                </div>

                <div class="form-check mb-3">
                    {{ form.include_history(class="form-check-input", id="include-history") }}
                    <label class="form-check-label" for="include-history">
                        <i class="fas fa-clock me-1 text-secondary"></i>{{ form.include_history.label.text }}
                    </label>
                </div>

                <div class="form-check mb-3">
                    {{ form.include_source(class="form-check-input", id="include-source") }}
                    <label class="form-check-label" for="include-source">
                        <i class="fas fa-code me-1 text-success"></i>{{ form.include_source.label.text }}
                        <span class="d-block text-muted small">Includes Python, templates, static assets, and other files needed to run the app.</span>
                    </label>
                </div>

                <div class="form-check mb-4">
                    {{ form.include_cid_map(class="form-check-input", id="include-cid-map") }}
                    <label class="form-check-label" for="include-cid-map">
                        <i class="fas fa-database me-1 text-primary"></i>{{ form.include_cid_map.label.text }}
                        <span class="d-block text-muted small">Include the CID to content map so other environments can load referenced definitions.</span>
                    </label>
                    <div class="ms-4 mt-3{{ '' if form.include_cid_map.data else ' d-none' }}" id="include-unreferenced-cid-container">
                        <div class="form-check">
                            {{ form.include_unreferenced_cid_data(class="form-check-input", id="include-unreferenced-cid-data", disabled=(not form.include_cid_map.data)) }}
                            <label class="form-check-label" for="include-unreferenced-cid-data">
                                {{ form.include_unreferenced_cid_data.label.text }}
                                <span class="d-block text-muted small">Add CID content that is not referenced by other exported items.</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    {{ form.secret_key.label(class="form-label") }}
                    {{ form.secret_key(class="form-control" + (" is-invalid" if form.secret_key.errors else "")) }}
                    {% if form.secret_key.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.secret_key.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="form-text">Secrets will be encrypted using this key. Keep it safe to decrypt them later.</div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-between flex-wrap gap-2">
                    <a href="{{ url_for('main.settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>

    <script id="export-preview-data" type="application/json">{{ export_preview | tojson }}</script>

    <div class="alert alert-info mt-4" role="alert">
        <i class="fas fa-info-circle me-2"></i>Exports are saved as a CID-backed JSON file. Secrets are encrypted with the key you provide—share it securely with anyone importing this export.
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var exportForm = document.querySelector('form');
            var sizeValue = document.getElementById('export-size-value');
            var sizeStatus = document.getElementById('export-size-status');
            var updateTimeoutId = null;
            var activeController = null;
            var previewDataElement = document.getElementById('export-preview-data');
            var exportPreview = {};
            var previewSections = ['aliases', 'servers', 'variables', 'secrets'];
            var previewUpdateTimeoutId = null;

            if (previewDataElement) {
                try {
                    exportPreview = JSON.parse(previewDataElement.textContent || '{}');
                } catch (error) {
                    exportPreview = {};
                }
            }

            function escapeHtml(value) {
                if (typeof value !== 'string') {
                    value = value === undefined || value === null ? '' : String(value);
                }
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function renderMessage(message) {
                return '<div class="text-muted small fst-italic">' + escapeHtml(message || '') + '</div>';
            }

            function updatePreview(section) {
                var container = document.querySelector('[data-export-preview="' + section + '"]');
                if (!container) {
                    return;
                }

                var sectionData = exportPreview && exportPreview[section] ? exportPreview[section] : {};
                var includeCheckbox = document.getElementById('include-' + section);
                var includeCollection = includeCheckbox ? includeCheckbox.checked : false;

                if (!includeCollection) {
                    var notSelectedMessage = sectionData.not_selected_message || 'Not selected for export.';
                    container.innerHTML = renderMessage(notSelectedMessage);
                    return;
                }

                var available = Array.isArray(sectionData.available) ? sectionData.available : [];
                var includeDisabledCheckbox = document.getElementById('include-disabled-' + section);
                var includeTemplatesCheckbox = document.getElementById('include-template-' + section);
                var includeDisabled = includeDisabledCheckbox ? includeDisabledCheckbox.checked : false;
                var includeTemplates = includeTemplatesCheckbox ? includeTemplatesCheckbox.checked : false;

                var selected = available.filter(function (item) {
                    if (!item) {
                        return false;
                    }
                    var isTemplate = Boolean(item.template);
                    var isEnabled = Boolean(item.enabled);
                    if (isTemplate && !includeTemplates) {
                        return false;
                    }
                    if (!isEnabled && !includeDisabled) {
                        return false;
                    }
                    return true;
                });

                if (!selected.length) {
                    var emptyMessage = sectionData.empty_message || 'No items available for export.';
                    container.innerHTML = renderMessage(emptyMessage);
                    return;
                }

                var listItems = selected
                    .map(function (item) {
                        return '<li>' + escapeHtml(item.name || '') + '</li>';
                    })
                    .join('');
                container.innerHTML = '<ul class="list-unstyled small mb-0">' + listItems + '</ul>';
            }

            function updateAllPreviews() {
                previewSections.forEach(updatePreview);
            }

            function schedulePreviewUpdate() {
                if (previewUpdateTimeoutId) {
                    clearTimeout(previewUpdateTimeoutId);
                }

                previewUpdateTimeoutId = window.setTimeout(function () {
                    previewUpdateTimeoutId = null;
                    updateAllPreviews();
                }, 0);
            }

            function updateSizeStatus(message, isError) {
                if (!sizeStatus) {
                    return;
                }
                sizeStatus.textContent = message || '';
                if (isError) {
                    sizeStatus.classList.add('text-danger');
                    sizeStatus.classList.remove('text-muted');
                } else {
                    sizeStatus.classList.remove('text-danger');
                    sizeStatus.classList.add('text-muted');
                }
            }

            function updateExportSize() {
                if (!exportForm || !sizeValue) {
                    return;
                }

                if (activeController && typeof activeController.abort === 'function') {
                    activeController.abort();
                }

                activeController = window.AbortController ? new AbortController() : null;

                var requestInit = {
                    method: 'POST',
                    body: new FormData(exportForm),
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                };

                if (activeController) {
                    requestInit.signal = activeController.signal;
                }

                updateSizeStatus('Calculating…', false);

                fetch('{{ url_for('main.export_size') }}', requestInit)
                    .then(function (response) {
                        return response.json().catch(function () {
                            return {};
                        }).then(function (data) {
                            if (!response.ok) {
                                data.ok = false;
                                throw data;
                            }
                            return data;
                        });
                    })
                    .then(function (data) {
                        if (!data || !data.ok) {
                            throw data;
                        }
                        sizeValue.textContent = data.formatted_size;
                        updateSizeStatus('', false);
                    })
                    .catch(function (error) {
                        if (error && error.name === 'AbortError') {
                            return;
                        }

                        sizeValue.textContent = '—';
                        var message = 'Unable to calculate size.';
                        if (error && error.errors) {
                            var errorLists = Object.values(error.errors).filter(function (value) {
                                return Array.isArray(value) && value.length;
                            });
                            if (errorLists.length) {
                                message = errorLists[0][0];
                            }
                        }
                        updateSizeStatus(message, true);
                    });
            }

            function scheduleExportSizeUpdate() {
                if (!exportForm) {
                    return;
                }

                if (updateTimeoutId) {
                    clearTimeout(updateTimeoutId);
                }

                updateTimeoutId = window.setTimeout(function () {
                    updateTimeoutId = null;
                    updateExportSize();
                }, 200);
            }

            function setupDependentOptions(triggerId, containerId, optionIds) {
                var trigger = document.getElementById(triggerId);
                var container = document.getElementById(containerId);
                if (!trigger || !container) {
                    return;
                }

                var inputs = optionIds
                    .map(function (id) { return document.getElementById(id); })
                    .filter(function (element) { return !!element; });

                function sync() {
                    var enabled = trigger.checked;
                    container.classList.toggle('d-none', !enabled);
                    inputs.forEach(function (input) {
                        input.disabled = !enabled;
                        if (!enabled) {
                            input.checked = false;
                        }
                    });
                    scheduleExportSizeUpdate();
                    schedulePreviewUpdate();
                }

                trigger.addEventListener('change', sync);
                sync();
            }

            setupDependentOptions('include-aliases', 'alias-options', [
                'include-disabled-aliases',
                'include-template-aliases',
            ]);
            setupDependentOptions('include-servers', 'server-options', [
                'include-disabled-servers',
                'include-template-servers',
            ]);
            setupDependentOptions('include-variables', 'variable-options', [
                'include-disabled-variables',
                'include-template-variables',
            ]);
            setupDependentOptions('include-secrets', 'secret-options', [
                'include-disabled-secrets',
                'include-template-secrets',
            ]);

            var cidMapCheckbox = document.getElementById('include-cid-map');
            var unreferencedContainer = document.getElementById('include-unreferenced-cid-container');
            var unreferencedInput = document.getElementById('include-unreferenced-cid-data');

            if (cidMapCheckbox && unreferencedContainer && unreferencedInput) {
                function syncUnreferencedVisibility() {
                    var enabled = cidMapCheckbox.checked;
                    unreferencedContainer.classList.toggle('d-none', !enabled);
                    unreferencedInput.disabled = !enabled;
                    if (!enabled) {
                        unreferencedInput.checked = false;
                    }
                }

                cidMapCheckbox.addEventListener('change', syncUnreferencedVisibility);
                syncUnreferencedVisibility();
            }

            if (exportForm) {
                exportForm.addEventListener('submit', function () {
                    if (activeController && typeof activeController.abort === 'function') {
                        activeController.abort();
                    }
                });

                var watchedInputs = exportForm.querySelectorAll('input, select, textarea');
                watchedInputs.forEach(function (input) {
                    input.addEventListener('change', scheduleExportSizeUpdate);
                    input.addEventListener('change', schedulePreviewUpdate);
                    if (input.tagName === 'TEXTAREA' || input.type === 'text' || input.type === 'password') {
                        input.addEventListener('input', scheduleExportSizeUpdate);
                        input.addEventListener('input', schedulePreviewUpdate);
                    }
                });

                scheduleExportSizeUpdate();
                schedulePreviewUpdate();
            }
        });
    </script>
{% endblock %}
