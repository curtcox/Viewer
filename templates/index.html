{% extends "base.html" %}

{% block content %}
{% if current_user.is_authenticated and cross_reference %}
<div class="container">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-4">
        <div>
            <h1 class="h2 mb-1">Workspace Cross Reference</h1>
            <p class="text-muted mb-0">Explore how your aliases, servers, and content identifiers connect. Hover or focus to inspect related items.</p>
        </div>
        <div class="mt-3 mt-lg-0 text-lg-end">
            <a href="{{ url_for('main.aliases') }}" class="badge text-bg-primary text-decoration-none me-2">
                <i class="fas fa-link me-1"></i>Aliases
            </a>
            <a href="{{ url_for('main.servers') }}" class="badge text-bg-success text-decoration-none me-2">
                <i class="fas fa-server me-1"></i>Servers
            </a>
            <a href="{{ url_for('main.uploads') }}" class="badge text-bg-dark text-decoration-none">
                <i class="fas fa-fingerprint me-1"></i>CIDs
            </a>
        </div>
    </div>

    <div class="row g-4 crossref-board" data-crossref-container>
        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-semibold text-uppercase small">Aliases</span>
                    <span class="badge rounded-pill text-bg-primary">{{ cross_reference.aliases|length }}</span>
                </div>
                {% if cross_reference.aliases %}
                <div class="list-group list-group-flush">
                    {% for alias in cross_reference.aliases %}
                    <div class="list-group-item position-relative crossref-entity crossref-alias"
                         data-entity-type="alias"
                         data-entity-key="{{ alias.entity_key }}"
                         data-implies="{{ alias.implied_keys|join(' ') }}"
                         data-incoming-refs="{{ alias.incoming_refs|join(' ') }}"
                         data-outgoing-refs="{{ alias.outgoing_refs|join(' ') }}"
                         tabindex="0">
                        <div class="d-flex align-items-center justify-content-between">
                            <a href="{{ alias.url }}" class="fw-semibold text-decoration-none">{{ alias.name }}</a>
                            <i class="fas fa-link text-muted"></i>
                        </div>
                        {% if alias.target_path %}
                        <div class="small text-muted mt-1">{{ alias.target_path }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="card-body text-muted small">
                    <p class="mb-0">No aliases yet. Create one to route friendly URLs to servers or CIDs.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-semibold text-uppercase small">Servers</span>
                    <span class="badge rounded-pill text-bg-success">{{ cross_reference.servers|length }}</span>
                </div>
                {% if cross_reference.servers %}
                <div class="list-group list-group-flush">
                    {% for server in cross_reference.servers %}
                    <div class="list-group-item position-relative crossref-entity crossref-server"
                         data-entity-type="server"
                         data-entity-key="{{ server.entity_key }}"
                         data-implies="{{ server.implied_keys|join(' ') }}"
                         data-incoming-refs="{{ server.incoming_refs|join(' ') }}"
                         data-outgoing-refs="{{ server.outgoing_refs|join(' ') }}"
                         tabindex="0">
                        <div class="d-flex align-items-center justify-content-between">
                            <a href="{{ server.url }}" class="fw-semibold text-decoration-none">{{ server.name }}</a>
                            <i class="fas fa-server text-muted"></i>
                        </div>
                        {% if server.definition_cid %}
                        <div class="small text-muted mt-1">
                            Definition CID:
                            {{ render_cid_link(server.definition_cid) }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="card-body text-muted small">
                    <p class="mb-0">No servers defined yet. Build one to power dynamic routes.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-semibold text-uppercase small">CIDs</span>
                    <span class="badge rounded-pill text-bg-dark">{{ cross_reference.cids|length }}</span>
                </div>
                {% if cross_reference.cids %}
                <div class="list-group list-group-flush">
                    {% for cid in cross_reference.cids %}
                    <div class="list-group-item crossref-entity crossref-cid"
                         data-entity-type="cid"
                         data-entity-key="{{ cid.entity_key }}"
                         data-implies="{{ cid.implied_keys|join(' ') }}"
                         data-incoming-refs="{{ cid.incoming_refs|join(' ') }}"
                         data-outgoing-refs="{{ cid.outgoing_refs|join(' ') }}"
                         tabindex="0">
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="badge text-bg-dark text-uppercase">CID</span>
                                <span class="small text-muted">Preview</span>
                            </div>
                            <div>{{ render_cid_link(cid.cid) }}</div>
                            <div class="small text-muted font-monospace">
                                {{ cid.preview }}{% if cid.preview_truncated %}...{% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="card-body text-muted small">
                    <p class="mb-0">No CIDs referenced by your aliases or servers yet.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-semibold text-uppercase small">References</span>
                    <span class="badge rounded-pill text-bg-secondary">{{ cross_reference.references|length }}</span>
                </div>
                {% if cross_reference.references %}
                <div class="list-group list-group-flush">
                    {% for ref in cross_reference.references %}
                    <div class="list-group-item crossref-reference"
                         data-reference-key="{{ ref.key }}"
                         data-source-key="{{ ref.source_key }}"
                         data-target-key="{{ ref.target_key }}"
                         tabindex="0">
                        <div class="d-flex align-items-center justify-content-between gap-3">
                            <div class="flex-grow-1">
                                <div class="text-uppercase small text-muted">{{ ref.source_label }}</div>
                                {% if ref.source_type == 'cid' %}
                                <span class="badge text-bg-dark">{{ ref.source_cid_short }}</span>
                                {% elif ref.source_url %}
                                <a href="{{ ref.source_url }}" class="fw-semibold text-decoration-none">{{ ref.source_name }}</a>
                                {% else %}
                                <span class="fw-semibold">{{ ref.source_name }}</span>
                                {% endif %}
                            </div>
                            <i class="fas fa-arrow-right text-muted"></i>
                            <div class="flex-grow-1 text-end">
                                <div class="text-uppercase small text-muted">{{ ref.target_label }}</div>
                                {% if ref.target_type == 'cid' %}
                                <span class="badge text-bg-dark">{{ ref.target_cid_short }}</span>
                                {% elif ref.target_url %}
                                <a href="{{ ref.target_url }}" class="fw-semibold text-decoration-none">{{ ref.target_name }}</a>
                                {% else %}
                                <span class="fw-semibold">{{ ref.target_name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="card-body text-muted small">
                    <p class="mb-0">No references detected between your entities yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="container">
    <div class="row align-items-center py-5">
        <div class="col-lg-6">
            <h1 class="display-4 fw-bold text-primary mb-4">
                Welcome to SecureApp
            </h1>
            <p class="lead mb-4">
                Experience secure, premium content with our advanced access control system.
                Get detailed insights into your web interactions with comprehensive HTTP request tracking.
            </p>
            <div class="d-flex gap-3">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.profile') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-gauge-high me-2"></i>Go to Dashboard
                </a>
                {% elif AUTH_AVAILABLE %}
                <a href="{{ LOGIN_URL }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Get Started
                </a>
                {% else %}
                <a href="#" onclick="alert('Authentication not available.'); return false;" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Get Started
                </a>
                {% endif %}
                <a href="{{ url_for('main.plans') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-info-circle me-2"></i>View Plans
                </a>
            </div>
        </div>
        <div class="col-lg-6 text-center">
            <i class="fas fa-shield-alt text-primary" style="font-size: 12rem; opacity: 0.1;"></i>
        </div>
    </div>

    <div class="row py-5">
        <div class="col-12">
            <h2 class="text-center mb-5">Why Choose SecureApp?</h2>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="fas fa-lock text-primary mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">Secure Access</h5>
                    <p class="card-text">
                        Multi-layered security with user authentication, payment verification,
                        and terms acceptance tracking.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="fas fa-chart-line text-success mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">Request Tracking</h5>
                    <p class="card-text">
                        Comprehensive HTTP request analysis with detailed headers,
                        parameters, and environmental data.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="fas fa-credit-card text-warning mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">Payment Management</h5>
                    <p class="card-text">
                        Track your subscription history with detailed payment records
                        and expiration monitoring.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row py-5">
        <div class="col-12">
            <h2 class="text-center mb-5">Observability</h2>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="fas fa-fire text-danger mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">Logfire</h5>
                    <p class="card-text">
                        Monitor requests, database usage, and background activity with
                        structured Logfire traces tailored for SecureApp.
                    </p>
                    {% if LOGFIRE_AVAILABLE and LOGFIRE_PROJECT_URL %}
                    <a href="{{ LOGFIRE_PROJECT_URL }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-up-right-from-square me-2"></i>View Logfire Project
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary" type="button" disabled>
                        <i class="fas fa-ban me-2"></i>Logfire project not available
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <i class="fas fa-diagram-project text-info mb-3" style="font-size: 3rem;"></i>
                    <h5 class="card-title">LangSmith</h5>
                    <p class="card-text">
                        Debug and iterate on language workflows with LangSmith monitoring
                        powered through the Logfire integration.
                    </p>
                    {% if LANGSMITH_AVAILABLE and LANGSMITH_PROJECT_URL %}
                    <a href="{{ LANGSMITH_PROJECT_URL }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-up-right-from-square me-2"></i>Open LangSmith Project
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary" type="button" disabled>
                        <i class="fas fa-ban me-2"></i>LangSmith project not available
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row py-5 bg-light rounded">
        <div class="col-12">
            <h2 class="text-center mb-5">How It Works</h2>
        </div>
        <div class="col-md-3 mb-4 text-center">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                <span class="fw-bold">1</span>
            </div>
            <h6>Create Account</h6>
            <p class="text-muted">Register with your email and create a secure password</p>
        </div>
        <div class="col-md-3 mb-4 text-center">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                <span class="fw-bold">2</span>
            </div>
            <h6>Choose Plan</h6>
            <p class="text-muted">Select a subscription plan that fits your needs</p>
        </div>
        <div class="col-md-3 mb-4 text-center">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                <span class="fw-bold">3</span>
            </div>
            <h6>Accept Terms</h6>
            <p class="text-muted">Review and accept our terms and conditions</p>
        </div>
        <div class="col-md-3 mb-4 text-center">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                <span class="fw-bold">4</span>
            </div>
            <h6>Deploy Securely</h6>
            <p class="text-muted">Launch your secure applications with confidence</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
{% if current_user.is_authenticated and cross_reference %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.querySelector('[data-crossref-container]');
    if (!container) {
        return;
    }

    const escapeSelector = function (value) {
        if (!value) {
            return '';
        }
        if (window.CSS && typeof window.CSS.escape === 'function') {
            return window.CSS.escape(value);
        }
        return value.replace(/(["'\\#.:;,!?+<>=~*^$\[\](){}|\/-])/g, '\\$1');
    };

    const clearHighlight = function () {
        container.classList.remove('is-hovering');
        container.querySelectorAll('[data-entity-key], [data-reference-key]').forEach((el) => {
            el.classList.remove('is-highlighted', 'is-related', 'is-reference', 'is-dimmed');
        });
    };

    const highlightEntity = function (key, className) {
        if (!key) {
            return;
        }
        const selector = '[data-entity-key="' + escapeSelector(key) + '"]';
        container.querySelectorAll(selector).forEach((el) => el.classList.add(className));
    };

    const highlightReference = function (key, className) {
        if (!key) {
            return;
        }
        const selector = '[data-reference-key="' + escapeSelector(key) + '"]';
        container.querySelectorAll(selector).forEach((el) => el.classList.add(className));
    };

    const markDimmed = function () {
        const active = new Set();
        container.querySelectorAll('.is-highlighted, .is-related, .is-reference').forEach((el) => active.add(el));
        container.querySelectorAll('[data-entity-key], [data-reference-key]').forEach((el) => {
            if (!active.has(el)) {
                el.classList.add('is-dimmed');
            }
        });
    };

    const applyHighlight = function (element) {
        clearHighlight();
        if (!element) {
            return;
        }

        container.classList.add('is-hovering');
        element.classList.add('is-highlighted');

        if (element.hasAttribute('data-reference-key')) {
            const sourceKey = element.getAttribute('data-source-key');
            const targetKey = element.getAttribute('data-target-key');
            if (sourceKey) {
                highlightEntity(sourceKey, 'is-related');
            }
            if (targetKey) {
                highlightEntity(targetKey, 'is-related');
            }
        } else {
            const implied = (element.getAttribute('data-implies') || '').split(/\s+/).filter(Boolean);
            implied.forEach((key) => highlightEntity(key, 'is-related'));

            const refKeys = (element.getAttribute('data-outgoing-refs') || '').split(/\s+/).filter(Boolean);
            refKeys.forEach((key) => highlightReference(key, 'is-reference'));

            const incomingRefKeys = (element.getAttribute('data-incoming-refs') || '').split(/\s+/).filter(Boolean);
            incomingRefKeys.forEach((key) => highlightReference(key, 'is-reference'));
        }

        markDimmed();
    };

    const attachListeners = function (element) {
        const enter = () => applyHighlight(element);
        const leave = () => clearHighlight();
        element.addEventListener('mouseenter', enter);
        element.addEventListener('focus', enter);
        element.addEventListener('mouseleave', leave);
        element.addEventListener('blur', leave);
    };

    container.querySelectorAll('[data-entity-key], [data-reference-key]').forEach(attachListeners);
    container.addEventListener('mouseleave', clearHighlight);
});
</script>
{% endif %}
{% endblock %}
