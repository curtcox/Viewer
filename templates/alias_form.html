{% extends "base.html" %}
{% from "_ai_helpers.html" import ai_text_controls, ai_action_button %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-link me-2"></i>{{ title }}</h2>
                <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Aliases
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Alias Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Alias names can only contain letters, numbers, dots, hyphens, and underscores. This is the path visitors type: <code>/{{ form.name.data or 'alias-name' }}</code>.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.target_path.label(class="form-label") }}
                            {{ form.target_path(class="form-control" + (" is-invalid" if form.target_path.errors else "")) }}
                            {% if form.target_path.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.target_path.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Provide a relative URL on this server. Examples: <code>/{{ alias.name if alias else 'cid123' }}</code>, <code>/servers/example</code>, or <code>/dashboard?view=latest</code>.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.match_type.label.text }}</label>
                            <div class="btn-group" role="group" aria-label="Alias match type">
                                {% for subfield in form.match_type %}
                                <input type="radio"
                                       class="btn-check"
                                       name="{{ form.match_type.name }}"
                                       id="match-type-{{ loop.index }}"
                                       value="{{ subfield._value() }}"
                                       {% if subfield.checked %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="match-type-{{ loop.index }}">{{ subfield.label.text }}</label>
                                {% endfor %}
                            </div>
                            {% if form.match_type.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.match_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Choose how the alias pattern is matched. Literal matches behave like the original aliases.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="match-pattern-group">
                            {{ form.match_pattern.label(class="form-label") }}
                            {{ form.match_pattern(class="form-control" + (" is-invalid" if form.match_pattern.errors else "")) }}
                            {% if form.match_pattern.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.match_pattern.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Patterns are matched against request paths starting with <code>/</code>. Glob patterns support <code>*</code>, <code>?</code>, and <code>**</code>. Flask patterns accept converters like <code>&lt;username&gt;</code>.
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-check form-switch mb-3">
                            {{ form.ignore_case(class="form-check-input", role="switch") }}
                            {{ form.ignore_case.label(class="form-check-label") }}
                        </div>

                        <div class="mb-3" data-alias-testing>
                            {{ form.test_strings.label(class="form-label") }}
                            {{ form.test_strings(class="form-control") }}
                            <div class="form-text">Enter one path per line to try the current configuration without saving.</div>
                        </div>
                        <div data-alias-testing>
                        {{ ai_text_controls(form.test_strings.id, 'test strings', request_label='Ask AI to edit the test paths', helper_text='Describe how the AI should update the test paths before trying them.', context={'form': 'alias_form'}) }}
                        </div>

                        {% if test_results %}
                        <div class="mb-3" data-alias-testing>
                            <div class="alert alert-secondary mb-0">
                                <h6 class="alert-heading">Test Results</h6>
                                <ul class="list-unstyled mb-0 small">
                                    {% for value, matches in test_results %}
                                    <li>
                                        {% if matches %}
                                            <span class="badge bg-success me-2"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge bg-danger me-2"><i class="fas fa-times"></i></span>
                                        {% endif %}
                                        <code>{{ value.strip() }}</code>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <div class="d-flex gap-2 flex-wrap align-items-center">
                                <div data-alias-testing>
                                    {{ form.test_pattern(class="btn btn-outline-primary") }}
                                </div>
                                {{ ai_action_button(form.test_strings.id, button_label='AI', extra_classes='btn-outline-primary') }}
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if alias %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Current Alias</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Name:</strong><br>
                            <code>{{ alias.name }}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Last Updated:</strong><br>
                            {{ alias.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var matchTypeName = {{ form.match_type.name|tojson }};
    var matchTypeInputs = document.querySelectorAll('input[name="' + matchTypeName + '"]');
    var patternGroup = document.getElementById('match-pattern-group');
    var testingGroups = document.querySelectorAll('[data-alias-testing]');

    function updateVisibility() {
        var selected = document.querySelector('input[name="' + matchTypeName + '"]:checked');
        var isLiteral = selected && selected.value === 'literal';

        if (patternGroup) {
            patternGroup.classList.toggle('d-none', isLiteral);
        }

        testingGroups.forEach(function (element) {
            element.classList.toggle('d-none', isLiteral);
        });
    }

    matchTypeInputs.forEach(function (input) {
        input.addEventListener('change', updateVisibility);
    });

    updateVisibility();
});
</script>
{% endblock %}
