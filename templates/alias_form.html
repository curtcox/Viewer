{% extends "base.html" %}
{% from "_ai_helpers.html" import ai_text_controls, ai_action_button %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h2 class="mb-0"><i class="fas fa-link me-2"></i>{{ title }}</h2>
        <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Aliases
        </a>
    </div>

    <form method="POST" class="card shadow-sm">
        {{ form.hidden_tag() }}
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="alias-form-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="alias-form-config-tab" data-bs-toggle="tab" data-bs-target="#alias-form-config" type="button" role="tab" aria-controls="alias-form-config" aria-selected="true">
                        <i class="fas fa-sliders-h me-1"></i>Configuration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-matcher-tab" data-bs-toggle="tab" data-bs-target="#alias-form-matcher" type="button" role="tab" aria-controls="alias-form-matcher" aria-selected="false">
                        <i class="fas fa-vial me-1"></i>Interactive Matcher
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-guidance-tab" data-bs-toggle="tab" data-bs-target="#alias-form-guidance" type="button" role="tab" aria-controls="alias-form-guidance" aria-selected="false">
                        <i class="fas fa-lightbulb me-1"></i>Guidance
                    </button>
                </li>
                {% if alias %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-current-tab" data-bs-toggle="tab" data-bs-target="#alias-form-current" type="button" role="tab" aria-controls="alias-form-current" aria-selected="false">
                        <i class="fas fa-circle-info me-1"></i>Current Alias
                    </button>
                </li>
                {% endif %}
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="alias-form-tabs-content">
                <div class="tab-pane fade show active" id="alias-form-config" role="tabpanel" aria-labelledby="alias-form-config-tab">
                    <div class="row g-4">
                        <div class="col-12">
                            {{ form.name.label(class="form-label") }}
                            <div
                                class="d-flex flex-wrap align-items-start gap-2"
                                data-rename-control
                                data-name-field="{{ form.name.id }}"
                                data-original-name="{{ alias.name if alias else '' }}"
                                data-rename-template="Rename to __name__"
                                data-save-as-template="Save As __name__"
                                data-name-pattern="^[a-zA-Z0-9._-]+$"
                            >
                                <div class="flex-grow-1">
                                    {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {% set alias_sample_name = form.name.data or (alias.name if alias else None) %}
                                        <div class="form-text">
                                            Alias names can only contain letters, numbers, dots, hyphens, and underscores. This is the path visitors type:
                                            {% if alias_sample_name %}
                                                {{ render_alias_link(alias_sample_name, label='/' ~ alias_sample_name, code=True) }}
                                            {% else %}
                                                <code>/alias-name</code>
                                            {% endif %}.
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="d-flex flex-column gap-2 align-items-start">
                                    <div class="d-flex gap-2 flex-wrap">
                                        {{ form.submit(
                                            class="btn btn-primary",
                                            id=form.submit.id,
                                            **{
                                                'data-primary-save': 'true',
                                                'data-default-label': form.submit.label.text,
                                            }
                                        ) }}
                                        <button
                                            type="submit"
                                            name="submit_action"
                                            value="save-as"
                                            class="btn btn-outline-primary d-none"
                                            data-save-as-button
                                            data-default-label="Save As"
                                        >
                                            Save As
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            {{ form.definition.label(class="form-label") }}
                            {{ form.definition(class="form-control" + (" is-invalid" if form.definition.errors else "")) }}
                            {% if form.definition.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.definition.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">Define the alias on the first line using <code>pattern -> /target [options]</code>. Additional lines can capture nested shortcuts, documentation, or examples.</div>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            {{ ai_text_controls(
                                form.definition.id,
                                'alias definition',
                                request_label='Ask AI to edit the alias definition',
                                helper_text='Describe how the AI should adjust the alias definition before saving.',
                                context={'form': 'alias_form'},
                                entity_type='alias',
                                entity_name=ai_entity_name|default(''),
                                entity_name_field=ai_entity_name_field|default(''),
                                interactions=interaction_history|default([]),
                                history_label='Recent alias edits and requests'
                            ) }}
                        </div>

                        <div class="col-12">
                            <div class="form-check form-switch">
                                {{ form.enabled(class="form-check-input", role="switch") }}
                                {{ form.enabled.label(class="form-check-label") }}
                                <div class="form-text">Disabled aliases remain visible for editing and search but will not route requests.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="alias-form-matcher" role="tabpanel" aria-labelledby="alias-form-matcher-tab">
                    <div class="mb-3">
                        <p class="text-muted">Use the live matcher to try paths without leaving the page. Results refresh automatically as you change the alias name or definition.</p>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body" data-alias-matcher data-alias-matcher-endpoint="{{ url_for('main.alias_match_preview') }}">
                                <label class="form-label" for="alias-live-matcher">Interactive Matcher</label>
                                <textarea id="alias-live-matcher" class="form-control" rows="3" placeholder="/docs/latest" data-alias-matcher-input></textarea>
                                <div class="form-text">Type URLs here to instantly check whether they match the current alias settings.</div>
                                <div class="mt-3">
                                    <label class="form-label mb-1">Alias Definition Preview</label>
                                    <div class="alias-definition-preview border rounded bg-body-tertiary" data-alias-definition-display style="max-height: 240px; overflow-y: auto;"></div>
                                    <div class="form-text">Highlights show how the definition responds to the paths above.</div>
                                </div>
                                <div class="mt-3" data-alias-matcher-results role="status" aria-live="polite"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="alias-form-guidance" role="tabpanel" aria-labelledby="alias-form-guidance-tab">
                    {% include "_alias_definition_help.html" %}
                </div>

                {% if alias %}
                <div class="tab-pane fade" id="alias-form-current" role="tabpanel" aria-labelledby="alias-form-current-tab">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="bg-light border rounded p-3 h-100">
                                <strong>Name:</strong><br>
                                <code>{{ alias.name }}</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="bg-light border rounded p-3 h-100">
                                <strong>Last Updated:</strong><br>
                                {{ alias.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
            <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>Cancel
            </a>
            <div class="d-flex gap-2 flex-wrap align-items-center">
                {{ ai_action_button(form.definition.id, button_label='AI', extra_classes='btn-outline-primary') }}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/rename_controls.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var matcherContainer = document.querySelector('[data-alias-matcher]');

    function escapeHtml(value) {
        return value.replace(/[&<>"']/g, function (character) {
            switch (character) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return character;
            }
        });
    }

    if (matcherContainer) {
        var matcherInput = matcherContainer.querySelector('[data-alias-matcher-input]');
        var matcherResults = matcherContainer.querySelector('[data-alias-matcher-results]');
        var matcherEndpoint = matcherContainer.getAttribute('data-alias-matcher-endpoint');
        var nameField = document.getElementById({{ form.name.id|tojson }});
        var definitionField = document.getElementById({{ form.definition.id|tojson }});
        var definitionPreview = matcherContainer.querySelector('[data-alias-definition-display]');
        var debounceTimer;
        var pendingController;

        function renderDefinitionPreviewFromText(definitionText) {
            if (!definitionPreview) {
                return;
            }

            var lines = (definitionText || '').split(/\r?\n/);
            var hasContent = lines.some(function (line) { return line.length > 0; });

            if (!hasContent) {
                definitionPreview.innerHTML = '<div class="px-2 py-3 text-muted small">Definition preview will appear here.</div>';
                return;
            }

            var html = lines.map(function (line, index) {
                var classes = ['d-flex', 'align-items-start', 'gap-2', 'px-2', 'py-1', 'font-monospace', 'bg-body-tertiary'];
                if (index !== lines.length - 1) {
                    classes.push('border-bottom', 'border-light');
                }
                var displayText = line ? escapeHtml(line) : '&nbsp;';
                return '<div class="' + classes.join(' ') + '">' +
                    '<span class="text-muted small pt-1" style="width: 2.5rem;">' + (index + 1) + '.</span>' +
                    '<span class="text-muted pt-1"><i class="fas fa-circle"></i></span>' +
                    '<span class="flex-grow-1">' + displayText + '</span>' +
                '</div>';
            }).join('');

            definitionPreview.innerHTML = html;
        }

        function renderDefinitionPreview(definitionData) {
            if (!definitionPreview) {
                return;
            }

            if (!definitionData || !Array.isArray(definitionData.lines) || !definitionData.lines.length) {
                renderDefinitionPreviewFromText(definitionField ? definitionField.value : '');
                return;
            }

            var lines = definitionData.lines;
            var hasActivePaths = !!definitionData.has_active_paths;

            var html = lines.map(function (line, index) {
                var classes = ['d-flex', 'align-items-start', 'gap-2', 'px-2', 'py-1', 'font-monospace'];
                if (index !== lines.length - 1) {
                    classes.push('border-bottom', 'border-light');
                }

                var indicatorClass = 'text-muted';
                var indicatorIcon = 'fa-circle';

                if (line.is_mapping) {
                    if (line.has_error) {
                        classes.push('bg-danger-subtle', 'border-start', 'border-4', 'border-danger');
                        indicatorClass = 'text-danger';
                        indicatorIcon = 'fa-triangle-exclamation';
                    } else if (hasActivePaths) {
                        if (line.matches_any) {
                            classes.push('bg-success-subtle', 'border-start', 'border-4', 'border-success');
                            indicatorClass = 'text-success';
                            indicatorIcon = 'fa-check';
                        } else {
                            classes.push('bg-danger-subtle', 'border-start', 'border-4', 'border-danger');
                            indicatorClass = 'text-danger';
                            indicatorIcon = 'fa-times';
                        }
                    } else {
                        classes.push('bg-body-secondary-subtle');
                    }
                } else {
                    classes.push('bg-body-tertiary');
                }

                var lineText = line.text ? escapeHtml(line.text) : '&nbsp;';
                var errorHtml = '';
                if (line.has_error && line.parse_error) {
                    errorHtml = '<span class="text-danger small ms-2">' + escapeHtml(String(line.parse_error)) + '</span>';
                }

                return '<div class="' + classes.join(' ') + '">' +
                    '<span class="text-muted small pt-1" style="width: 2.5rem;">' + line.number + '.</span>' +
                    '<span class="' + indicatorClass + ' pt-1"><i class="fas ' + indicatorIcon + '"></i></span>' +
                    '<span class="flex-grow-1">' + lineText + errorHtml + '</span>' +
                '</div>';
            }).join('');

            definitionPreview.innerHTML = html;
        }

        function renderPlaceholder() {
            if (matcherResults) {
                matcherResults.innerHTML = '<div class="text-muted small">Type a path above to preview matches instantly.</div>';
            }
            renderDefinitionPreviewFromText(definitionField ? definitionField.value : '');
        }

        function scheduleMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runMatcherUpdate, 250);
        }

        function runMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }

            var rawLines = matcherInput.value.split(/\r?\n/);
            var hasContent = rawLines.some(function (line) {
                return line.trim().length > 0;
            });

            if (!hasContent) {
                if (pendingController) {
                    pendingController.abort();
                    pendingController = null;
                }
                renderPlaceholder();
                return;
            }

            if (pendingController) {
                pendingController.abort();
            }
            pendingController = new AbortController();

            fetch(matcherEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameField ? nameField.value : '',
                    definition: definitionField ? definitionField.value : '',
                    paths: rawLines
                }),
                signal: pendingController.signal
            })
                .then(function (response) {
                    return response.json()
                        .then(function (data) {
                            return { ok: response.ok, data: data };
                        })
                        .catch(function () {
                            return { ok: response.ok, data: {} };
                        });
                })
                .then(function (result) {
                    pendingController = null;
                    renderDefinitionPreview(result.data && result.data.definition);

                    if (!matcherResults) {
                        return;
                    }

                    if (!result.ok) {
                        var errorMessage = (result.data && result.data.error) ? result.data.error : 'Unable to evaluate paths.';
                        matcherResults.innerHTML = '<div class="text-danger small">' + escapeHtml(errorMessage) + '</div>';
                        return;
                    }

                    var patternText = result.data && result.data.pattern ? String(result.data.pattern) : '';
                    var items = Array.isArray(result.data && result.data.results) ? result.data.results : [];

                    if (!items.length) {
                        matcherResults.innerHTML = '<div class="text-muted small">No paths to evaluate.</div>';
                        return;
                    }

                    var listHtml = '<div class="small mb-2">Matching against <code>' + escapeHtml(patternText) + '</code></div>';
                    listHtml += '<ul class="list-unstyled mb-0">';
                    items.forEach(function (item) {
                        var matches = !!item.matches;
                        var badgeClass = matches ? 'bg-success' : 'bg-danger';
                        var icon = matches ? 'fa-check' : 'fa-times';
                        var valueText = item.value == null ? '' : String(item.value);
                        var displayText = valueText.trim() || '(empty)';
                        listHtml += '<li class="d-flex align-items-center gap-2 mb-1">'
                            + '<span class="badge ' + badgeClass + '"><i class="fas ' + icon + '"></i></span>'
                            + '<code class="mb-0">' + escapeHtml(displayText) + '</code>'
                            + '</li>';
                    });
                    listHtml += '</ul>';
                    matcherResults.innerHTML = listHtml;
                })
                .catch(function (error) {
                    if (error.name === 'AbortError') {
                        return;
                    }
                    pendingController = null;
                    renderDefinitionPreviewFromText(definitionField ? definitionField.value : '');
                    if (!matcherResults) {
                        return;
                    }
                    matcherResults.innerHTML = '<div class="text-danger small">Unable to evaluate paths.</div>';
                });
        }

        if (matcherInput) {
            matcherInput.addEventListener('input', scheduleMatcherUpdate);
        }
        if (definitionField) {
            definitionField.addEventListener('input', function () {
                renderDefinitionPreviewFromText(definitionField.value);
                scheduleMatcherUpdate();
            });
        }
        if (nameField) {
            nameField.addEventListener('input', scheduleMatcherUpdate);
        }

        renderPlaceholder();
    }
});
</script>
{% endblock %}
