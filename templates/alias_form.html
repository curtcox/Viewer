{% extends "base.html" %}
{% from "_ai_helpers.html" import ai_text_controls, ai_action_button %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-link me-2"></i>{{ title }}</h2>
                <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Aliases
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Alias Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% set alias_sample_name = form.name.data or (alias.name if alias else None) %}
                                <div class="form-text">
                                    Alias names can only contain letters, numbers, dots, hyphens, and underscores. This is the path visitors type:
                                    {% if alias_sample_name %}
                                        {{ render_alias_link(alias_sample_name, label='/' ~ alias_sample_name, code=True) }}
                                    {% else %}
                                        <code>/alias-name</code>
                                    {% endif %}.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.target_path.label(class="form-label") }}
                            {{ form.target_path(class="form-control" + (" is-invalid" if form.target_path.errors else "")) }}
                            {% if form.target_path.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.target_path.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% set alias_target_example = '/' ~ (alias.name if alias else 'cid123') %}
                                <div class="form-text">
                                    Provide a relative URL on this server. Examples:
                                    {{ render_url_link(alias_target_example, label=alias_target_example, code=True) }},
                                    {{ render_url_link('/servers/example', label='/servers/example', code=True) }},
                                    or {{ render_url_link('/dashboard?view=latest', label='/dashboard?view=latest', code=True) }}.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ form.match_type.label.text }}</label>
                            <div class="btn-group" role="group" aria-label="Alias match type">
                                {% for subfield in form.match_type %}
                                <input type="radio"
                                       class="btn-check"
                                       name="{{ form.match_type.name }}"
                                       id="match-type-{{ loop.index }}"
                                       value="{{ subfield._value() }}"
                                       {% if subfield.checked %}checked{% endif %}>
                                <label class="btn btn-outline-primary" for="match-type-{{ loop.index }}">{{ subfield.label.text }}</label>
                                {% endfor %}
                            </div>
                            {% if form.match_type.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.match_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Choose how the alias pattern is matched. Literal matches behave like the original aliases.
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="match-pattern-group">
                            {{ form.match_pattern.label(class="form-label") }}
                            {{ form.match_pattern(class="form-control" + (" is-invalid" if form.match_pattern.errors else "")) }}
                            {% if form.match_pattern.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.match_pattern.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">
                                    Patterns are matched against request paths starting with <code>/</code>. Glob patterns support <code>*</code>, <code>?</code>, and <code>**</code>. Flask patterns accept converters like <code>&lt;username&gt;</code>.
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-check form-switch mb-3">
                            {{ form.ignore_case(class="form-check-input", role="switch") }}
                            {{ form.ignore_case.label(class="form-check-label") }}
                        </div>

                        <div class="mb-3">
                            {{ form.definition.label(class="form-label") }}
                            {{ form.definition(class="form-control" + (" is-invalid" if form.definition.errors else "")) }}
                            {% if form.definition.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.definition.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">Document multi-line alias context, nested shortcuts, and routing notes here.</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" data-alias-testing>
                            {{ form.test_strings.label(class="form-label") }}
                            {{ form.test_strings(class="form-control") }}
                            <div class="form-text">Enter one path per line to try the current configuration without saving.</div>
                        </div>
                        <div data-alias-testing>
                        {{ ai_text_controls(
                            form.test_strings.id,
                            'test strings',
                            request_label='Ask AI to edit the test paths',
                            helper_text='Describe how the AI should update the test paths before trying them.',
                            context={'form': 'alias_form'},
                            entity_type='alias',
                            entity_name=ai_entity_name|default(''),
                            entity_name_field=ai_entity_name_field|default(''),
                            interactions=interaction_history|default([]),
                            history_label='Recent alias edits and requests'
                        ) }}
                        </div>

                        {% if test_results %}
                        <div class="mb-3" data-alias-testing>
                            <div class="alert alert-secondary mb-0">
                                <h6 class="alert-heading">Test Results</h6>
                                <ul class="list-unstyled mb-0 small">
                                    {% for value, matches in test_results %}
                                    <li>
                                        {% if matches %}
                                            <span class="badge bg-success me-2"><i class="fas fa-check"></i></span>
                                        {% else %}
                                            <span class="badge bg-danger me-2"><i class="fas fa-times"></i></span>
                                        {% endif %}
                                        <code>{{ value.strip() }}</code>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3" data-alias-matcher data-alias-matcher-endpoint="{{ url_for('main.alias_match_preview') }}">
                            <label class="form-label" for="alias-live-matcher">Interactive Matcher</label>
                            <textarea id="alias-live-matcher" class="form-control" rows="3" placeholder="/docs/latest" data-alias-matcher-input></textarea>
                            <div class="form-text">Type URLs here to instantly check whether they match the current alias settings without leaving the page.</div>
                            <div class="mt-2" data-alias-matcher-results role="status" aria-live="polite"></div>
                        </div>

                        <div class="mb-3">
                            {% include "_alias_definition_help.html" %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <div class="d-flex gap-2 flex-wrap align-items-center">
                                <div data-alias-testing>
                                    {{ form.test_pattern(class="btn btn-outline-primary") }}
                                </div>
                                {{ ai_action_button(form.test_strings.id, button_label='AI', extra_classes='btn-outline-primary') }}
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if alias %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Current Alias</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Name:</strong><br>
                            <code>{{ alias.name }}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Last Updated:</strong><br>
                            {{ alias.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var matchTypeName = {{ form.match_type.name|tojson }};
    var matchTypeInputs = document.querySelectorAll('input[name="' + matchTypeName + '"]');
    var patternGroup = document.getElementById('match-pattern-group');
    var testingGroups = document.querySelectorAll('[data-alias-testing]');
    var matcherContainer = document.querySelector('[data-alias-matcher]');

    function updateVisibility() {
        var selected = document.querySelector('input[name="' + matchTypeName + '"]:checked');
        var isLiteral = selected && selected.value === 'literal';

        if (patternGroup) {
            patternGroup.classList.toggle('d-none', isLiteral);
        }

        testingGroups.forEach(function (element) {
            element.classList.toggle('d-none', isLiteral);
        });
    }

    matchTypeInputs.forEach(function (input) {
        input.addEventListener('change', updateVisibility);
    });

    updateVisibility();

    function escapeHtml(value) {
        return value.replace(/[&<>"']/g, function (character) {
            switch (character) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return character;
            }
        });
    }

    if (matcherContainer) {
        var matcherInput = matcherContainer.querySelector('[data-alias-matcher-input]');
        var matcherResults = matcherContainer.querySelector('[data-alias-matcher-results]');
        var matcherEndpoint = matcherContainer.getAttribute('data-alias-matcher-endpoint');
        var nameField = document.getElementById({{ form.name.id|tojson }});
        var patternField = document.getElementById({{ form.match_pattern.id|tojson }});
        var ignoreCaseField = document.getElementById({{ form.ignore_case.id|tojson }});
        var debounceTimer;
        var pendingController;

        function selectedMatchType() {
            var selected = document.querySelector('input[name="' + matchTypeName + '"]:checked');
            return selected ? selected.value : 'literal';
        }

        function renderPlaceholder() {
            if (!matcherResults) {
                return;
            }
            matcherResults.innerHTML = '<div class="text-muted small">Type a path above to preview matches instantly.</div>';
        }

        function scheduleMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runMatcherUpdate, 250);
        }

        function runMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }

            var rawLines = matcherInput.value.split(/\r?\n/);
            var hasContent = rawLines.some(function (line) {
                return line.trim().length > 0;
            });

            if (!hasContent) {
                if (pendingController) {
                    pendingController.abort();
                    pendingController = null;
                }
                renderPlaceholder();
                return;
            }

            if (pendingController) {
                pendingController.abort();
            }
            pendingController = new AbortController();

            fetch(matcherEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameField ? nameField.value : '',
                    match_type: selectedMatchType(),
                    match_pattern: patternField ? patternField.value : '',
                    ignore_case: ignoreCaseField ? ignoreCaseField.checked : false,
                    paths: rawLines
                }),
                signal: pendingController.signal
            })
                .then(function (response) {
                    return response.json()
                        .then(function (data) {
                            return { ok: response.ok, data: data };
                        })
                        .catch(function () {
                            return { ok: response.ok, data: {} };
                        });
                })
                .then(function (result) {
                    pendingController = null;
                    if (!matcherResults) {
                        return;
                    }

                    if (!result.ok) {
                        var errorMessage = (result.data && result.data.error) ? result.data.error : 'Unable to evaluate paths.';
                        matcherResults.innerHTML = '<div class="text-danger small">' + escapeHtml(errorMessage) + '</div>';
                        return;
                    }

                    var patternText = result.data && result.data.pattern ? String(result.data.pattern) : '';
                    var items = Array.isArray(result.data && result.data.results) ? result.data.results : [];

                    if (!items.length) {
                        matcherResults.innerHTML = '<div class="text-muted small">No paths to evaluate.</div>';
                        return;
                    }

                    var listHtml = '<div class="small mb-2">Matching against <code>' + escapeHtml(patternText) + '</code></div>';
                    listHtml += '<ul class="list-unstyled mb-0">';
                    items.forEach(function (item) {
                        var matches = !!item.matches;
                        var badgeClass = matches ? 'bg-success' : 'bg-danger';
                        var icon = matches ? 'fa-check' : 'fa-times';
                        var valueText = item.value == null ? '' : String(item.value);
                        var displayText = valueText.trim() || '(empty)';
                        listHtml += '<li class="d-flex align-items-center gap-2 mb-1">'
                            + '<span class="badge ' + badgeClass + '"><i class="fas ' + icon + '"></i></span>'
                            + '<code class="mb-0">' + escapeHtml(displayText) + '</code>'
                            + '</li>';
                    });
                    listHtml += '</ul>';
                    matcherResults.innerHTML = listHtml;
                })
                .catch(function (error) {
                    if (error.name === 'AbortError') {
                        return;
                    }
                    pendingController = null;
                    if (!matcherResults) {
                        return;
                    }
                    matcherResults.innerHTML = '<div class="text-danger small">Unable to evaluate paths.</div>';
                });
        }

        if (matcherInput) {
            matcherInput.addEventListener('input', scheduleMatcherUpdate);
        }
        if (patternField) {
            patternField.addEventListener('input', scheduleMatcherUpdate);
        }
        if (nameField) {
            nameField.addEventListener('input', scheduleMatcherUpdate);
        }
        if (ignoreCaseField) {
            ignoreCaseField.addEventListener('change', scheduleMatcherUpdate);
        }
        matchTypeInputs.forEach(function (input) {
            input.addEventListener('change', scheduleMatcherUpdate);
        });

        renderPlaceholder();
    }
});
</script>
{% endblock %}
