{% extends "base.html" %}
{% from "_ai_helpers.html" import ai_text_controls, ai_action_button %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h2 class="mb-0"><i class="fas fa-link me-2"></i>{{ title }}</h2>
        <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Aliases
        </a>
    </div>

    <form method="POST" class="card shadow-sm">
        {{ form.hidden_tag() }}
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="alias-form-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="alias-form-config-tab" data-bs-toggle="tab" data-bs-target="#alias-form-config" type="button" role="tab" aria-controls="alias-form-config" aria-selected="true">
                        <i class="fas fa-sliders-h me-1"></i>Configuration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-matcher-tab" data-bs-toggle="tab" data-bs-target="#alias-form-matcher" type="button" role="tab" aria-controls="alias-form-matcher" aria-selected="false">
                        <i class="fas fa-vial me-1"></i>Interactive Matcher
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-guidance-tab" data-bs-toggle="tab" data-bs-target="#alias-form-guidance" type="button" role="tab" aria-controls="alias-form-guidance" aria-selected="false">
                        <i class="fas fa-lightbulb me-1"></i>Guidance
                    </button>
                </li>
                {% if alias %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="alias-form-current-tab" data-bs-toggle="tab" data-bs-target="#alias-form-current" type="button" role="tab" aria-controls="alias-form-current" aria-selected="false">
                        <i class="fas fa-circle-info me-1"></i>Current Alias
                    </button>
                </li>
                {% endif %}
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="alias-form-tabs-content">
                <div class="tab-pane fade show active" id="alias-form-config" role="tabpanel" aria-labelledby="alias-form-config-tab">
                    <div class="row g-4">
                        <div class="col-12">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% set alias_sample_name = form.name.data or (alias.name if alias else None) %}
                                <div class="form-text">
                                    Alias names can only contain letters, numbers, dots, hyphens, and underscores. This is the path visitors type:
                                    {% if alias_sample_name %}
                                        {{ render_alias_link(alias_sample_name, label='/' ~ alias_sample_name, code=True) }}
                                    {% else %}
                                        <code>/alias-name</code>
                                    {% endif %}.
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            {{ form.definition.label(class="form-label") }}
                            {{ form.definition(class="form-control" + (" is-invalid" if form.definition.errors else "")) }}
                            {% if form.definition.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.definition.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="form-text">Define the alias on the first line using <code>pattern -> /target [options]</code>. Additional lines can capture nested shortcuts, documentation, or examples.</div>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            {{ ai_text_controls(
                                form.definition.id,
                                'alias definition',
                                request_label='Ask AI to edit the alias definition',
                                helper_text='Describe how the AI should adjust the alias definition before saving.',
                                context={'form': 'alias_form'},
                                entity_type='alias',
                                entity_name=ai_entity_name|default(''),
                                entity_name_field=ai_entity_name_field|default(''),
                                interactions=interaction_history|default([]),
                                history_label='Recent alias edits and requests'
                            ) }}
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="alias-form-matcher" role="tabpanel" aria-labelledby="alias-form-matcher-tab">
                    <div class="mb-3">
                        <p class="text-muted">Use the live matcher to try paths without leaving the page. Results refresh automatically as you change the alias name or definition.</p>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body" data-alias-matcher data-alias-matcher-endpoint="{{ url_for('main.alias_match_preview') }}">
                                <label class="form-label" for="alias-live-matcher">Interactive Matcher</label>
                                <textarea id="alias-live-matcher" class="form-control" rows="3" placeholder="/docs/latest" data-alias-matcher-input></textarea>
                                <div class="form-text">Type URLs here to instantly check whether they match the current alias settings.</div>
                                <div class="mt-2" data-alias-matcher-results role="status" aria-live="polite"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="alias-form-guidance" role="tabpanel" aria-labelledby="alias-form-guidance-tab">
                    {% include "_alias_definition_help.html" %}
                </div>

                {% if alias %}
                <div class="tab-pane fade" id="alias-form-current" role="tabpanel" aria-labelledby="alias-form-current-tab">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="bg-light border rounded p-3 h-100">
                                <strong>Name:</strong><br>
                                <code>{{ alias.name }}</code>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="bg-light border rounded p-3 h-100">
                                <strong>Last Updated:</strong><br>
                                {{ alias.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
            <a href="{{ url_for('main.aliases') }}" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>Cancel
            </a>
            <div class="d-flex gap-2 flex-wrap align-items-center">
                {{ ai_action_button(form.definition.id, button_label='AI', extra_classes='btn-outline-primary') }}
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var matcherContainer = document.querySelector('[data-alias-matcher]');

    function escapeHtml(value) {
        return value.replace(/[&<>"']/g, function (character) {
            switch (character) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return character;
            }
        });
    }

    if (matcherContainer) {
        var matcherInput = matcherContainer.querySelector('[data-alias-matcher-input]');
        var matcherResults = matcherContainer.querySelector('[data-alias-matcher-results]');
        var matcherEndpoint = matcherContainer.getAttribute('data-alias-matcher-endpoint');
        var nameField = document.getElementById({{ form.name.id|tojson }});
        var definitionField = document.getElementById({{ form.definition.id|tojson }});
        var debounceTimer;
        var pendingController;

        function renderPlaceholder() {
            if (!matcherResults) {
                return;
            }
            matcherResults.innerHTML = '<div class="text-muted small">Type a path above to preview matches instantly.</div>';
        }

        function scheduleMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runMatcherUpdate, 250);
        }

        function runMatcherUpdate() {
            if (!matcherEndpoint || !matcherInput) {
                return;
            }

            var rawLines = matcherInput.value.split(/\r?\n/);
            var hasContent = rawLines.some(function (line) {
                return line.trim().length > 0;
            });

            if (!hasContent) {
                if (pendingController) {
                    pendingController.abort();
                    pendingController = null;
                }
                renderPlaceholder();
                return;
            }

            if (pendingController) {
                pendingController.abort();
            }
            pendingController = new AbortController();

            fetch(matcherEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: nameField ? nameField.value : '',
                    definition: definitionField ? definitionField.value : '',
                    paths: rawLines
                }),
                signal: pendingController.signal
            })
                .then(function (response) {
                    return response.json()
                        .then(function (data) {
                            return { ok: response.ok, data: data };
                        })
                        .catch(function () {
                            return { ok: response.ok, data: {} };
                        });
                })
                .then(function (result) {
                    pendingController = null;
                    if (!matcherResults) {
                        return;
                    }

                    if (!result.ok) {
                        var errorMessage = (result.data && result.data.error) ? result.data.error : 'Unable to evaluate paths.';
                        matcherResults.innerHTML = '<div class="text-danger small">' + escapeHtml(errorMessage) + '</div>';
                        return;
                    }

                    var patternText = result.data && result.data.pattern ? String(result.data.pattern) : '';
                    var items = Array.isArray(result.data && result.data.results) ? result.data.results : [];

                    if (!items.length) {
                        matcherResults.innerHTML = '<div class="text-muted small">No paths to evaluate.</div>';
                        return;
                    }

                    var listHtml = '<div class="small mb-2">Matching against <code>' + escapeHtml(patternText) + '</code></div>';
                    listHtml += '<ul class="list-unstyled mb-0">';
                    items.forEach(function (item) {
                        var matches = !!item.matches;
                        var badgeClass = matches ? 'bg-success' : 'bg-danger';
                        var icon = matches ? 'fa-check' : 'fa-times';
                        var valueText = item.value == null ? '' : String(item.value);
                        var displayText = valueText.trim() || '(empty)';
                        listHtml += '<li class="d-flex align-items-center gap-2 mb-1">'
                            + '<span class="badge ' + badgeClass + '"><i class="fas ' + icon + '"></i></span>'
                            + '<code class="mb-0">' + escapeHtml(displayText) + '</code>'
                            + '</li>';
                    });
                    listHtml += '</ul>';
                    matcherResults.innerHTML = listHtml;
                })
                .catch(function (error) {
                    if (error.name === 'AbortError') {
                        return;
                    }
                    pendingController = null;
                    if (!matcherResults) {
                        return;
                    }
                    matcherResults.innerHTML = '<div class="text-danger small">Unable to evaluate paths.</div>';
                });
        }

        if (matcherInput) {
            matcherInput.addEventListener('input', scheduleMatcherUpdate);
        }
        if (definitionField) {
            definitionField.addEventListener('input', scheduleMatcherUpdate);
        }
        if (nameField) {
            nameField.addEventListener('input', scheduleMatcherUpdate);
        }

        renderPlaceholder();
    }
});
</script>
{% endblock %}
