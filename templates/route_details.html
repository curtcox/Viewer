{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
        <h1 class="h3 mb-0">Route Explorer</h1>
        <span class="badge bg-secondary text-wrap">
            Path:
            <a class="font-monospace link-light text-decoration-none"
               href="{{ resolution.normalized_path }}">
                {{ resolution.normalized_path }}
            </a>
        </span>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between gap-3">
                <div>
                    <div class="text-uppercase text-muted small">Final response</div>
                    <div class="fs-5 fw-semibold">
                        {% if resolution.final_status is not none %}
                        <span class="badge text-bg-primary me-2">{{ resolution.final_status }}</span>
                        {% else %}
                        <span class="badge text-bg-secondary me-2">Varies</span>
                        {% endif %}
                        {{ resolution.final_summary }}
                    </div>
                    {% if resolution.redirect_target %}
                    <div class="text-muted small mt-2">Redirect target: <code>{{ resolution.redirect_target }}</code></div>
                    {% endif %}
                    {% if resolution.chain_limited %}
                    <div class="text-warning small mt-2">
                        {% if resolution.loop_detected %}
                        Redirect loop detected after {{ resolution.redirects_followed }} redirects.
                        {% else %}
                        Redirect chain truncated after {{ resolution.redirects_followed }} redirects.
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="list-group">
        {% for step in resolution.steps %}
        <div class="list-group-item py-4" data-request-path="{{ step.request_path }}">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                        <span class="badge {{ step.badge_class }}">
                            <i class="fas {{ step.icon_class }} me-1"></i>{{ step.category_label }}
                        </span>
                        {% if step.title_url %}
                        <a class="fw-semibold text-decoration-none" href="{{ step.title_url }}">{{ step.title }}</a>
                        {% else %}
                        <span class="fw-semibold">{{ step.title }}</span>
                        {% endif %}
                    </div>
                    <div class="mb-2 small">
                        <a class="link-primary text-decoration-none" href="{{ step.request_url }}">{{ step.request_path }}</a>
                    </div>
                    {% if step.definition_excerpt %}
                    <pre class="bg-light border rounded small px-3 py-2 font-monospace mb-2">{{ step.definition_excerpt }}</pre>
                    {% endif %}
                    <p class="mb-2">{{ step.description }}</p>
                    {% if step.extra_details %}
                    <div class="text-muted small mb-2">{{ step.extra_details }}</div>
                    {% endif %}
                    {% if step.redirect_target %}
                    <div class="text-muted small mb-2">
                        Redirects to
                        <a class="text-decoration-none" href="{{ step.redirect_target }}">{{ step.redirect_target }}</a>
                    </div>
                    {% endif %}
                    {% if step.cid_markup %}
                    <div class="mt-2">{{ step.cid_markup }}</div>
                    {% endif %}
                    {% if step.link_url %}
                    <div class="small">
                        <a class="link-secondary text-decoration-none" href="{{ step.link_url }}">{{ step.link_label or 'View details' }}</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="list-group-item py-4 text-muted">No routing steps recorded.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}
